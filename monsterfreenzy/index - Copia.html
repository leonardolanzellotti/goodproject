<!DOCTYPE html5>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
		<title>Monster Freenzy</title>
		<link href='icon.png' rel='shortcut icon'>
		<style>
			body {background-color:white;overflow:hidden;padding:0;margin:0;}
		</style>
		<script src="enchant/build/enchant.js"></script>
	</head>
	<body>
	<script>
    
		/*
			scores rank:
			02 - each party taken
			05 - watermelon special
			10 - pumpking special
			20 - each move left (when victorious)
		*/
    
    	credits = function(){
			console.log("============================================================================");
			console.log("===                                                                      ===");
			console.log("=== Em Desenvolvimento por Leonardo Lanzellotti | Monster Freenzy - 2015 ===");
			console.log("===                                                                      ===");
			console.log("============================================================================");
      	};
      
      	credits();
      	enchant();
      
      	window.onload = function () {

			var game = new Core(80*6,80*9);

			game.preload(
				"bgA.jpg",
				"bgB.jpg",
				"bgC.jpg",
				"bgD.jpg",
				"bgE.jpg",
				"bgF.jpg",
				"bgG.jpg",
				"bgH.jpg",
				"semgrade80x80.png",
				"monsterLevels58x55.png",
				"WatermelonSpecial107x80.png",
				"MessageBombWatermelon200x23.png",
				"MessageFlashPumpkin200x26.png",
				"PumpkinSpecial26x26.png",
				"ice1.3.png",
				"ice1.4.png",
				"restart.png",
				"back.png",
				"music.png",
				"arrayLeft.png",
				"arrayRight.png",
				"witch.png",
				"specialTile.png",
				"MessageWinner350x88.png",
				"MessageLoser350x88.png",
				"noice.png",
				"collectall.png",
				"target.png",
				"cannon.png",
				"shot.png"
			);

			game.preload(
				"themeIntro.ogg",
				"themeLevel.ogg",
				"menu.wav",
				"lockedLevel.wav",
				"select.wav",
				"selectCancel.wav",
				"selectedRelease.wav",
				"upMonster.ogg",
				"ice.wav",
				"absorb.wav",
				"winner.ogg",
				"themeLevel2.ogg",
				"loser.ogg"
			);

			game.fps = 30;
    
			game.onload = function () {

				//========== VARIABLES ============
				var GAME_STATUS = 0;
				var levelActual = 1;//default is 1
				var levelMaxUnlocked = levelActual;
				var plain;
				var goalsPosX = [[110],[55,155],[0,110,210]];
				var score_init = 350;
				var score = score_init;
				var __score__ = score;
				var monsterLevelIndex = 0;
				var __monsterLevel__ = [[0,25],[25,50],[50,75],[75,100],[100,125]];
				var check_wait = false;
				var __COST_RANDOM__ = 20;
				var __COST_NO_ICE__ = 500;
				var __COST_COLLECT_SAME__ = 450;
				var __COST_REMOVE_ONE__ = 100;
				var waitRemoveOne = false;
				var waitCollectSame = false;
				var __ENABLE_SAVE__ = true;
				var debugMasterCounter = 0;
				var debugMasterTarget = 10;
	  
	 			//=================================
				var storage = {
					items:function(){
						return localStorage;
					},
					init:function(){

						var items = this.items();

						if(items.length == 0){
							localStorage["levelActual"] = 1;
							localStorage["levelMaxUnlocked"] = 1;
							localStorage["score"] = score_init;		
						}

						if((__x=items["levelActual"]) != 1){
							levelActual = (__x==undefined)?1:__x;
						}else{
							levelActual = 1;
						}
						if((__x=items["levelMaxUnlocked"]) != 1){
							levelMaxUnlocked = (__x==undefined)?1:__x;
						}else{
							levelMaxUnlocked = 1;
						}
						if((__x=items["score"]) != 1){
							score = (__x==undefined)?score_init:__x;
						} else {
							score = score_init;
						}	      

					},
					save:function(a,b,c){
						localStorage["levelActual"] = a;
						localStorage["levelMaxUnlocked"] = b;
						localStorage["score"] = c;
					},
					clear:function(){
						localStorage["levelActual"] = 1;
						localStorage["levelMaxUnlocked"] = 1;
						localStorage["score"] = score_init;
					}
				};

				//=================================
				if(__ENABLE_SAVE__){
					storage.init();
				}

	  			//=================================

				var Witch = enchant.Class.create(enchant.Sprite, {
					initialize:function(n){
						enchant.Sprite.call(this,70,50);
						this.image = game.assets["witch.png"];
						this.n = n;
						this.x = 0;
						this.y = (game.height-this.height)/2;
						this.frame = 0;
						this._visible = false;
						this.scale(-1.5,1.5);
						this.next = this.n+1;
						this.ready = true;
						game.rootScene.addChild(this);	      

						this.message();

					},
					message:function(){

						GAME_STATUS = 2;
						var g = new Group();
						g.x = -game.width;
						g.y = (game.height-120)/2-10;
						g.width = game.width;
						g.height = 120;

						var l = new Label("Cuidado");
						l.font = "40px Arial";
						l.x = 0;
						l.y = 0;
						l.width = g.width;
						l.height = g.height/2;
						l.color = "white";
						l.textAlign = "center";
						l.backgroundColor = "rgba(0,0,0,0.8)";
						g.addChild(l);

						l = new Label("BRUXA!");
						l.font = "52px sans-serif";
						l.x = 0;
						l.y = g.height/2;
						l.width = g.width;
						l.height = g.height/2;
						l.color = "red";
						l.textAlign = "center";
						l.backgroundColor = "rgba(255,255,255,0.8)";
						g.addChild(l);

						game.rootScene.addChild(g);

						g.tl.moveBy(game.width+25,0,8).moveBy(-25,0,5).delay(10).scaleTo(0.94,0.94,3).scaleTo(1.14,1.14,4).scaleTo(1,1,4).delay(10).moveBy(-25,0,5).moveBy(game.width+25,0,8)
						.then(function(){
						GAME_STATUS = 1;
						game.rootScene.removeChild(this);
						});

					},
					action: function(){

						this.next -= 1;

						if(this.next == 0){

							this.ready = false;

							var bg = new Label();
							bg.width = game.width;
							bg.height = game.height;
							bg.backgroundColor = "rgb(0,0,0)";
							bg.opacity = 0;
							game.rootScene.addChild(bg);
							bg.tl.fadeTo(0.90,42).then(function(){
								game.rootScene.removeChild(this);
							});

							this.next = this.n+1;
							this.x = 0;
							this._visible = true;

							var arr = [];
							while(arr.length < this.n){

								var r = Math.floor(Math.random()*plain.row);
								var c = Math.floor(Math.random()*plain.col);

								if(plain.cell[r][c] != undefined){
									if(plain.iceLayer[r][c] == false){
										arr.push([r,c]);
									}
								}
							}

							plain.inkCells(arr);

							this.tl.moveBy(game.width,0,25).		
								then(function(){		
									this._visible=false;
									game.assets["absorb.wav"].play();
									plain.absorb(arr);
									this.ready = true;
								});

						}
					}	
				});
	  
	  var RestrictivePlain = enchant.Class.create(enchant.Group,{
	    initialize:function(row,col,blockTypes,blockGoals,iceLayer){
	      enchant.Group.call(this);
	      this.row = row;
	      this.col = col;
	      
	      this.width = this.col*80;
	      this.height = this.row*80;
	      
	      this.x = (game.width-this.width)/2;
	      this.y = (game.height-this.height)/2;
	      
	      this.blockTypes = (blockTypes == undefined)?[0]:blockTypes;
	      this.cell = [];
	      this.iceLayer = [];
	      
	      this.path = [];
	      this.frame = -1;
	      this.unInk = false;
	      
	      this.blockGoalsPosX = [];
	      this.blockGoalsPosY = 20;
	      
	      this.blockGoals = blockGoals;
	      this.validTypeGoals = [];
	      this.moves = 0;
	      
	      for(var r=0;r<this.row;r++){
		var __cell__ = [];
		var __ice__ = [];
		for(var c=0;c<this.col;c++){
		  __cell__.push(undefined);
		  __ice__.push(false);
		  
		}
		this.cell.push(__cell__);
		this.iceLayer.push(__ice__);
	      }
	      
	      this.iceLayerCounter = 0;
	      for(var i=0;i<iceLayer.length;i++){
		this.iceLayer[iceLayer[i][0]][iceLayer[i][1]] = true;
		this.iceLayerCounter++;
	      }
	      
	      this.iceLayerBefore = new Group();
	      this.iceLayerBefore.width = this.width;
	      this.iceLayerBefore.height = this.height;
	      this.addChild(this.iceLayerBefore);
	      
	      var bg = new Label();
	      bg.backgroundColor = "rgba(0,0,0,0.7)";
	      bg.width = this.width;
	      bg.height = this.height;
	      this.addChild(bg);
	      
	      this.iceLayerAfter = new Group();
	      this.iceLayerAfter.x = this.x;
	      this.iceLayerAfter.y = this.y;
	      this.iceLayerAfter.width = this.width;
	      this.iceLayerAfter.height = this.height;
	      //this.addChild(this.iceLayerAfter);
	      
	      this.witch = undefined;
	      
	      //console.log(this.row,this.col,this.x,this.y,this.width,this.height,this.blockTypes,this.cell,this.iceLayer);
	      game.rootScene.addChild(this);
	      game.rootScene.addChild(this.iceLayerAfter);
	      this.goals();
	      this.movesLabel();
	      this.pathLengthLabel();
	      this.refreshIceLayer();
	      this.buttons();
	      
	      this.message();
	      
	    },
	    turnOn:function(){
	    
	      for(var r=0;r<this.row;r++){
		for(var c=0;c<this.col;c++){
		
		  if(this.cell[r][c] != undefined && this.iceLayer[r][c] == false && this.cell[r][c].frame != 15){
		    
		    this.cell[r][c].backgroundColor = 'rgba(200,200,40,0.7)';
		    
		  }
		
		}
	      }
	    
	    },
	    turnOff:function(){
	    
	      for(var r=0;r<this.row;r++){
		for(var c=0;c<this.col;c++){
		
		  if(this.cell[r][c] != undefined && this.iceLayer[r][c] == false && this.cell[r][c].frame != 15){
		    
		    this.cell[r][c].backgroundColor = 'rgba(0,0,0,0)';
		    
		  }
		
		}
	      }
	    
	    },
	    noIce:function(){
	    
	      var condition = false;
	    
	      for(var r=0;r<this.row;r++){
		for(var c=0;c<this.col;c++){
		
		  if ( this.iceLayer[r][c] == true){
		    condition = true;
		  }
		}
	      }
	      
	      if(condition == false){
	      
		alert("Nao ha gelo neste level!");
		return;
	      
	      }
	      
	      if ((confirm("Retirar todo o gelo. \n Custo: "+__COST_NO_ICE__+" scores. \n Seu score: "+score)) && score >= __COST_NO_ICE__) {
		score -= __COST_NO_ICE__;
	      }else{
		return;
	      }
	      
	      for(var r=0;r<this.row;r++){
		for(var c=0;c<this.col;c++){
		  this.iceLayer[r][c] = false;
		}
	      }
	      
	      this.refreshIceLayer();
	    
	    },
	    removeOne:function(b){
	    
	      if(this.cell[b[0]][b[1]] != undefined && this.iceLayer[b[0]][b[1]] == false && this.cell[b[0]][b[1]].frame != 15){
		this.takeCell(b);
	      }
	    
	    },
	    collectSame:function(b){
	    
	      if(this.cell[b[0]][b[1]] != undefined && this.iceLayer[b[0]][b[1]] == false && this.cell[b[0]][b[1]].frame != 15){
	      
		var frame = this.cell[b[0]][b[1]].frame;
		
		for(var r=0;r<this.row;r++){		
		  for(var c=0;c<this.col;c++){		  
		    if(this.cell[r][c] != undefined && this.cell[r][c].frame == frame && this.cell[r][c] != undefined && this.iceLayer[r][c] == false && this.cell[r][c].frame != 15){		    
		      //this.takeCell([r,c]); 		      
		      if(indexOf(this.path,[r,c]) == -1){
			this.path.push([r,c]);
		      }
		    }
		  }		
		}
	      		
	      }
	    
	    },	    
	    changeCells:function(cell1,cell2){
	      
	      var tmp = this.cell[cell1[0]][cell1[1]].frame;
	      this.cell[cell1[0]][cell1[1]].frame = this.cell[cell2[0]][cell2[1]].frame;
	      this.cell[cell2[0]][cell2[1]].frame = tmp;
	      
	      this.cell[cell1[0]][cell1[1]].visible = false;
	      this.cell[cell2[0]][cell2[1]].visible = false;
	      
	      var obj1 = this.cell[cell1[0]][cell1[1]];
	      var obj2 = this.cell[cell2[0]][cell2[1]];
	      
	      var clone;
	      
	      clone = new Sprite(this.cell[cell1[0]][cell1[1]].width,this.cell[cell1[0]][cell1[1]].height);
	      clone.x = this.x+this.cell[cell1[0]][cell1[1]].x;
	      clone.y = this.y+this.cell[cell1[0]][cell1[1]].y;
	      clone.image = this.cell[cell1[0]][cell1[1]].image;
	      clone.frame = this.cell[cell1[0]][cell1[1]].frame;
	      
	      game.rootScene.addChild(clone);
	      
	      clone.tl.delay(1+Math.floor(Math.random()*3)).moveTo(this.x+this.cell[cell2[0]][cell2[1]].x,this.y+this.cell[cell2[0]][cell2[1]].y,3).then(function(){
		obj2.visible = true;
		game.rootScene.removeChild(this);
	      });
	      
	      clone = new Sprite(this.cell[cell2[0]][cell2[1]].width,this.cell[cell2[0]][cell2[1]].height);
	      clone.x = this.x+this.cell[cell2[0]][cell2[1]].x;
	      clone.y = this.y+this.cell[cell2[0]][cell2[1]].y;
	      clone.image = this.cell[cell2[0]][cell2[1]].image;
	      clone.frame = this.cell[cell2[0]][cell2[1]].frame;
	      
	      game.rootScene.addChild(clone);
	      
	      clone.tl.delay(1+Math.floor(Math.random()*3)).moveTo(this.x+this.cell[cell1[0]][cell1[1]].x,this.y+this.cell[cell1[0]][cell1[1]].y,3).then(function(){
		obj1.visible = true;
		game.rootScene.removeChild(this);
	      });
	    
	    },
	    randomCells:function(){
	    
	      if ((confirm("Deseja embaralhar o tabuleiro? \n Custo: "+__COST_RANDOM__+" scores. \n Seu score: "+score)) && score >= __COST_RANDOM__) {
		score -= __COST_RANDOM__;
	      }else{
		return;
	      }
	      
	      var possibles = [];
	      
	      for(var r=0;r<this.row;r++){
		for(var c=0;c<this.col;c++){
		  //if(this.cell[r][c] != undefined){
		  if(this.cell[r][c] != undefined && this.cell[r][c].frame != 15 && this.iceLayer[r][c] == false){
		    possibles.push([r,c]);
		  }
		}
	      }
	      
	      	      var frameElements = possibles.map(function(p){return plain.cell[p[0]][p[1]].frame;});
	      var frameElementsSort = (frameElements.map(function(k){return k;})).sort();
	      var frameElementsCount = frameElementsSort.map(function(p){return [p,count(frameElementsSort,p)]});
	      
	      for(var i in frameElementsCount){
		if(frameElementsCount[i][1] >= 3){
		  
		  var pos,r1,r2;
		  var dpos = 0;
		  //--1
		  
		  pos = frameElements.indexOf(frameElementsCount[i][0],dpos);
		  dpos = pos+1;		  
		  r1 = possibles[pos];
		  r2 = possibles[0];
		  this.changeCells(r1,r2);
		  
		  //--2
		  
		  pos = frameElements.indexOf(frameElementsCount[i][0],dpos);
		  dpos = pos+1;		  
		  r1 = possibles[pos];
		  r2 = possibles[1];
		  this.changeCells(r1,r2);
		  
		  //--3
		  
		  pos = frameElements.indexOf(frameElementsCount[i][0],dpos);
		  dpos = pos+1;		  
		  r1 = possibles[pos];
		  r2 = possibles[2];
		  this.changeCells(r1,r2);
		  
		  //--
		  possibles.splice(0,1);
		  possibles.splice(0,1);
 		  possibles.splice(0,1);
		  
		  break;
		}
	      }
	      
	      var limit = 50000;
	      
	      while((limit-- >= 0) && possibles.length > 1){
	      
		var r1 = possibles[Math.floor(Math.random()*possibles.length)];
		var r2 = possibles[Math.floor(Math.random()*possibles.length)];
		
		if(r1 != r2){
		
		  this.changeCells(r1,r2);
		  //console.log("change = ",r1," com ",r2);
		  possibles.splice(possibles.indexOf(r1),1);
		  possibles.splice(possibles.indexOf(r2),1);
		
		}
		
	      
	      }
		
	      
	    
	    },
	    message:function(){
	      
	      GAME_STATUS = 2;
	      var g = new Group();
	      g.x = -game.width;
	      g.y = (game.height-120)/2-10;
	      g.width = game.width;
	      g.height = 120;
	      
	      var l = new Label("Colete os monstros");
	      l.font = "40px courier-new";
	      l.x = 0;
	      l.y = 0;
	      l.width = g.width;
	      l.height = g.height/2;
	      l.color = "white";
	      l.textAlign = "center";
	      l.backgroundColor = "rgba(0,0,0,0.8)";
	      g.addChild(l);
	      
	      l = new Label("em 1 jogada!");
	      l.font = "50px courier-new";
	      l.x = 0;
	      l.y = g.height/2;
	      l.width = g.width;
	      l.height = g.height/2;
	      l.color = "black";
	      l.textAlign = "center";
	      l.backgroundColor = "rgba(255,255,255,0.8)";
	      g.addChild(l);
	      
	      game.rootScene.addChild(g);
	      
	      g.tl.moveBy(game.width+25,0,8).moveBy(-25,0,5).delay(10).scaleTo(0.94,0.94,3).scaleTo(1.14,1.14,4).scaleTo(1,1,4).delay(10).moveBy(-25,0,5).moveBy(game.width+25,0,8)
	      .then(function(){
		GAME_STATUS = 1;
		game.rootScene.removeChild(this);
	      });
	      
	    },
	    buttons:function(){
	      
	      back({x:10,y:game.height-10-80,scale:0.8});
	      restart({x:90,y:game.height-10-80,scale:0.8});
	      music({x:12,y:game.height-10-80-70,scale:0.7});
	      if(this.iceLayerCounter > 0){
		noIce({x:230,y:game.height-10-80,scale:0.7});
	      }
	      if(levelActual > 50){
		removeOne({x:310,y:game.height-10-80,scale:0.7});
	      }
	      if(levelActual > 75){
		collectSame({x:395,y:game.height-10-80,scale:0.8});
	      }
	      
	    },
	    absorb:function(arr){
	      
	      var k = 0;
	      for(var i in arr){
	      
		if(this.cell[arr[i][0]][arr[i][1]] != undefined){
		
		    var clone = new Sprite(80,80);
		    clone.x = plain.x+this.cell[arr[i][0]][arr[i][1]].x;
		    clone.y = plain.y+this.cell[arr[i][0]][arr[i][1]].y;
		    clone.image = this.cell[arr[i][0]][arr[i][1]].image;
		    clone.frame = this.cell[arr[i][0]][arr[i][1]].frame;
		    game.rootScene.addChild(clone);

		    plain.cell[arr[i][0]][arr[i][1]]._visible = false;
		    
		    clone.tl.
		    scaleTo(1.0,1.0,1).rotateBy(45,2,undefined).
		    scaleTo(0.9,0.9,1).rotateBy(45,2,undefined).
		    scaleTo(0.8,0.8,1).rotateBy(45,1,undefined).
		    scaleTo(0.7,0.7,1).rotateBy(45,1,undefined).
		    scaleTo(0.6,0.6,1).rotateBy(45,1,undefined).
		    scaleTo(0.5,0.5,1).rotateBy(45,1,undefined).
		    scaleTo(0.4,0.4,1).rotateBy(45,1,undefined).
		    scaleTo(0.3,0.3,1).rotateBy(45,1,undefined).
		    then(function(){
		      plain.removeChild(plain.cell[arr[k][0]][arr[k][1]]);
		      plain.cell[arr[k][0]][arr[k][1]] = undefined;
		      game.rootScene.removeChild(this);
		      k++;
		    });
		}
	      
	      }
	      
	      plain.inkCells([]);
	      
	    
	    },
	    specialTile:function(p){
	    
	      var s = new Sprite(80,80);
	      s.image = game.assets["specialTile.png"];
	      //s.frame = [0,0,0,0,1,1,1,1,2,2,2,2];
	      s.frame = 0;
	      s.x = p[1]*80;
	      s.y = p[0]*80;
	      this.addChild(s);
	      s.tl.fadeOut(15).then(function(){
		plain.removeChild(this);
	      });
	    
	    },	    
	    watermelon:function(p){
	    
	      var r = p[0];
	      var c = p[1];
		      
	      var spr = new Sprite(107,80);
	      spr.image = game.assets["WatermelonSpecial107x80.png"];
	      spr.frame = [0,0,1,1,2,2,3,3,4,4];
	      spr.x = plain.x+c*80-(107-80)/2;
	      spr.y = plain.y+r*80;
	      game.rootScene.addChild(spr);
	      
	      spr.tl.scaleTo(1.5,1.5,5).scaleTo(1.2,1.2,5).then(function(){
		game.rootScene.removeChild(this);	    
	      });
	      
	      var lbl = new Sprite(200,23);
	      lbl.image = game.assets["MessageBombWatermelon200x23.png"];
	      lbl.frame = 0;
	      lbl.x = (game.width-200)/2;
	      lbl.y = (game.height-23)/2;
	      lbl.scaleX = 2;
	      lbl.scaleY = 2;
	      game.rootScene.addChild(lbl);
	      
	      lbl.tl.scaleTo(2.5,3.8,12).moveBy(0,12,10).scaleTo(2,2,5).moveTo(lbl.x,0,5).then(function(){
		game.rootScene.removeChild(this);	    
	      });
	      
	      this.tl.delay(10).then(function(){
		var arr = [
		  [r-1,c-1],[r-1,c],[r-1,c+1],
		  [r,c-1],[r,c],[r,c+1],
		  [r+1,c-1],[r+1,c],[r+1,c+1]
		];
		
		for(var i in arr){
		  if(arr[i][0] > -1 && arr[i][0] < this.row && arr[i][1] > -1 && arr[i][1] < this.col && this.cell[arr[i][0]][arr[i][1]] != undefined){
		    if(this.iceLayer[arr[i][0]][arr[i][1]] == false){//dont take the ice cells!
		      this.specialTile(arr[i]);
		      this.takeCell(arr[i]);
		    }
		  }
		}
	      });
	      
	      __score__ += 5;	      
	      
	    },
	    pumpking:function(p){
	    
	      var r = p[0];
	      var c = p[1];
	      
	      var spr = new Sprite(26,26);
	      spr.image = game.assets["PumpkinSpecial26x26.png"];
	      spr.frame = [0,1,2,3,4,5,6,7,8,9,10,11];
	      spr.x = plain.x+c*80-(26-80)/2;
	      spr.y = plain.y+r*80;
	      spr.scaleX = 2;
	      spr.scaleY = 2;
	      game.rootScene.addChild(spr);
	      
	      spr.tl.scaleTo(2.5,2.5,6).scaleTo(2,2,6).then(function(){
		game.rootScene.removeChild(this);	    
	      });
	      
	      var lbl = new Sprite(200,26);
	      lbl.image = game.assets["MessageFlashPumpkin200x26.png"];
	      lbl.frame = 0;
	      lbl.x = (game.width-200)/2;
	      lbl.y = (game.height-26)/2;
	      lbl.scaleX = 2;
	      lbl.scaleY = 2;
	      game.rootScene.addChild(lbl);
	      
	      lbl.tl.scaleTo(2.5,3.8,12).moveBy(0,12,10).scaleTo(2,2,5).moveTo(lbl.x,0,5).then(function(){
		game.rootScene.removeChild(this);	    
	      });
	      
	      this.tl.delay(12).then(function(){
		var arr = [
		  [r,c-4],[r,c-3],[r,c-2],[r,c-1],[r,c],[r,c+1],[r,c+2],[r,c+3],[r,c+4],
		  [r-4,c],[r-3,c],[r-2,c],[r-1,c],[r+1,c],[r+2,c],[r+3,c],[r+4,c]
		];
		
		for(var i in arr){
		  if(arr[i][0] > -1 && arr[i][0] < this.row && arr[i][1] > -1 && arr[i][1] < this.col && this.cell[arr[i][0]][arr[i][1]] != undefined){
		    if(this.iceLayer[arr[i][0]][arr[i][1]] == false){//dont take the ice cells!
		      this.specialTile(arr[i]);
		      this.takeCell(arr[i]);
		    }
		  }
		}
	      });
		
	      __score__ += 10;
	    
	    },
	    check:function(){
	    
	      var nGoals = 0;
	      for(var i in this.blockGoals){
		nGoals += this.blockGoals[i];
	      }
	    
	      var on = 0;
	    
	      if(this.moves >= 0 && nGoals == 0){
	      
		on = 1;
		
		//console.log("win");
		if(levelMaxUnlocked == levelActual && levelMaxUnlocked < __monsterLevel__[__monsterLevel__.length-1][1]){
		  levelMaxUnlocked++;
		}
		levelActual = levelMaxUnlocked;
		
		__score__ += parseInt((this.moves*20));
		score -= (-__score__);
		check_wait = false;
		
		winner();		
		
		var kxx = setInterval(function(){
		  
		  if(check_wait){
		    main();
		    clearInterval(kxx);
		  }
		  
		},100);
	      }
	    
	      if(on != 1 && this.moves <= 0){
		//console.log("lose");
		
		check_wait = false;
		
		loser();		
		
		var kxx = setInterval(function(){
		  
		  if(check_wait){
		    main();
		    clearInterval(kxx);
		  }
		  
		},100);
	      }
	      
	      //console.log("playing");	    
	    
	    },
	    refreshIceLayer:function(){
		  
	      var len = 0;
	      
	      len = this.iceLayerBefore.childNodes.length;
	      for(var i=0;i<len;i++){
		this.iceLayerBefore.removeChild(this.iceLayerBefore.childNodes[0]);
	      }
	      
	      len = this.iceLayerAfter.childNodes.length;
	      for(var i=0;i<len;i++){
		this.iceLayerAfter.removeChild(this.iceLayerAfter.childNodes[0]);
	      }
	      
	      for(var r=0;r<this.row;r++){
		for(var c=0;c<this.col;c++){
		  var spr;
		  if(this.iceLayer[r][c] == true){
		    
		    spr = new Sprite(80,80);
		    spr.x = c*80;
		    spr.y = r*80;
		    spr.image = game.assets["ice1.3.png"];
		    spr.frame = 0;
		    this.iceLayerBefore.addChild(spr);
		    
		    spr = new Sprite(80,80);
		    spr.x = c*80;
		    spr.y = r*80;
		    spr.image = game.assets["ice1.4.png"];
		    spr.frame = 0;
		    this.iceLayerAfter.addChild(spr);
		    
		  }
		}
	      }
	    },
	    takeCell:function(b){
	      /*
		If case b appoint to ice cell, just remove this ice, otherwise remove the cell, check goals...
	      */
	      
	      if(this.iceLayer[b[0]][b[1]] == true){
	      
		this.iceLayer[b[0]][b[1]] = false;
		this.refreshIceLayer();
		game.assets["ice.wav"].play();
		
		for(var i in this.path){
		  if(this.path[i].toString() == b.toString()){
		    this.path.splice(i,1);		    
		    break;
		  }
		}
		
	      }else{
	      
		var i = -1;
		if(this.blockTypes.indexOf(12) >= 0){
		  i = 0;
		}else{
		  for(var v in this.validTypeGoals){
		    if(this.cell[b[0]][b[1]] != undefined && this.validTypeGoals[v][0] == this.cell[b[0]][b[1]].frame){
		      i = this.validTypeGoals[v][1];
		      break;
		    }
		  }
		}
		
		if(i > -1){
		  
		  var nBlock = -1;
		  if((k=this.blockTypes.indexOf(12)) >= 0){
		    nBlock = nBlock(k);
		  }else{
		    for(var v in this.blockTypes){
		      if(this.blockTypes[v] == this.cell[b[0]][b[1]].frame){
			nBlock = parseInt(v);
			break;
		      }
		    }
		  }
		  
		  var diffIce = 0;
		  
		  for(var i in this.path){
		    if(this.iceLayer[this.path[i][0]][this.path[i][1]] == true){
		      diffIce++;
		    }		    
		  }
		  
		  if(this.path.length - diffIce >= this.blockGoals[nBlock]){
		  
		  
		    var clone = new Sprite(80,80);
		    clone.x = plain.x+this.cell[b[0]][b[1]].x;
		    clone.y = plain.y+this.cell[b[0]][b[1]].y;
		    clone.image = this.cell[b[0]][b[1]].image;
		    clone.frame = this.cell[b[0]][b[1]].frame;
		    game.rootScene.addChild(clone);
		    //clone.tl.moveTo(plain.blockGoalsPosY+plain.blockGoalsPosX[i],plain.blockGoalsPosY,4).scaleTo(1.2,1.2,3).scaleTo(1,1,3).then(function(){
		    //clone.tl.scaleTo(1.1,1.1,4).moveTo(plain.blockGoalsPosY+plain.blockGoalsPosX[i],plain.blockGoalsPosY,4).scaleTo(1.2,1.2,3).scaleTo(1,1,3).then(function(){
		    clone.tl.scaleTo(1.1,1.1,4).moveTo(plain.blockGoalsPosY+plain.blockGoalsPosX[nBlock],plain.blockGoalsPosY,4).scaleTo(1.2,1.2,3).scaleTo(1,1,3).then(function(){
		      if(plain.blockGoals[nBlock] > 0){
			plain.blockGoals[nBlock] -= 1;
		      }
		      if(game.assets["upMonster.ogg"]._state == 0){game.assets["upMonster.ogg"].play();}
		      game.rootScene.removeChild(this);
		    });
		    
		    
		  }
		
		}
	      
		this.removeChild(this.cell[b[0]][b[1]]);
		this.cell[b[0]][b[1]] = undefined;
	      }
	      
	    },
	    pathLengthLabel:function(){
	      var bg = new Label("0");
	      bg.backgroundColor = "rgba(0,0,0,0.7)";
	      bg.width = 40;
	      bg.height = 40;
	      bg.color = "white";
	      bg.font = "35px sans-serif";
	      bg.textAlign = "center";
	      bg._visible = false;
	      game.rootScene.addChild(bg);
	      this.pathLabel = bg;
	      
	    },	    
	    refreshPathLengthLabel:function(){
	      var tr = this.path[this.path.length-1][0];
	      var tc = this.path[this.path.length-1][1];
	      
	      //this.pathLabel.x = this.x+80*(1+tc)-20;
	      if(tc == this.cell[0].length-1 && this.cell[0].length == 6){
		this.pathLabel.x = this.x+80*(tc)-20;
	      }else{
		this.pathLabel.x = this.x+80*(1+tc)-20;
	      }
	      this.pathLabel.y = this.y+80*(1+tr)-20;
	      
	      this.pathLabel.text = this.path.length;
	      if(this.path.length > 14){
		this.pathLabel.color = "red";
	      }else if(this.path.length > 6){
		this.pathLabel.color = "orange";
	      }else{
		this.pathLabel.color = "white";
		
	      }
	      this.pathLabel._visible = true;
	    },
	    movesLabel:function(){
	      var bg = new Label();
	      bg.backgroundColor = "rgba(0,0,0,0.7)";
	      bg.width = 90;
	      bg.height = 50;
	      bg.x = 370;
	      bg.y = 20;
	      bg.color = "white";
	      bg.font = "44px sans-serif";
	      bg.textAlign = "center";
	      bg.on("enterframe",function(){
		if(plain.moves >= 0){
		  this.text = plain.moves;
		}
	      });
	      game.rootScene.addChild(bg);	  
	    },
	    goals:function(){
	      
	      var n = 0;
	      for(var i in this.blockGoals){
		if(this.blockGoals[i] > 0){
		  this.validTypeGoals.push([this.blockTypes[i],n]);
		  n++;
		}
	      }
	      
	      //console.log(this.validTypeGoals);
	      this.blockGoalsPosX = goalsPosX[n-1];
	      
	      var g = new Group();
	      g.x = this.blockGoalsPosY;
	      g.y = this.blockGoalsPosY;
	      g.width = 330;
	      g.height = 80;
	      
	      var bg = new Label();
	      bg.backgroundColor = "rgba(0,0,0,0.7)";
	      bg.width = g.width;
	      bg.height = g.height;
	      g.addChild(bg);
	    
	      var j = 0;
	      for(var i in this.blockGoals){
		if(this.blockGoals[i] > 0){		
		  var spr = new Sprite(80,80);
		  spr.x = this.blockGoalsPosX[j];		
		  spr.y = 0;
		  spr.image = game.assets["semgrade80x80.png"];
		  spr.frame = this.blockTypes[i];
		  spr.scale(0.8,0.8);
		  
		  g.addChild(spr);
		  
		  var num = new Label("");
		  num.x = this.blockGoalsPosX[j]+70;
		  num.y = 30;
		  num.width = 46;
		  num.height = 30;
		  num.color = "white";
		  num.textAlign = "center";
		  num.text = this.blockGoals[i];
		  num.font = "26px sans-serif";
		  num.i = i;
		  
		  num.on("enterframe",function(){
		    if(plain.blockGoals[this.i] > 0){
		      this.text = plain.blockGoals[this.i];
		    }else{
		      this.text = "ok";
		    }
		  });

		  g.addChild(num);
		  
		  j++;
		}
	      }
	      
	      game.rootScene.addChild(g);
	    
	    },
	    hasEmptyCells:function(){
	      
	      for(var c=0;c<this.col;c++){
		if(this.cell[0][c] == undefined){
		  return true;
		}
	      }
	      
	      for(var r=0;r<this.row-1;r++){
		for(var c=0;c<this.col;c++){
		  //if(this.cell[r+1][c] == undefined && this.iceLayer[r][c] == false){
		  if(this.cell[r+1][c] == undefined && this.iceLayer[r][c] == false && this.cell[r][c] != undefined){
		    return true;
		  }
		}
	      }	    
	      return false;
	      
	    },
	    hasDownCells:function(){
	      
	      for(var r=0;r<this.row-1;r++){
		for(var c=0;c<this.col;c++){
		  if(this.cell[r+1][c] == undefined && this.iceLayer[r][c] == false && this.cell[r][c] != undefined){
		    return true;
		  }
		}
	      }	    
	      return false;
	      
	    },
	    inkCells:function(arr){
	    
	      for(var r=0;r<this.row;r++){
		for(var c=0;c<this.col;c++){
		  if(this.cell[r][c] != undefined){
		    this.cell[r][c].backgroundColor = "rgba(0,0,0,0)";
		  }
		}
	      }	    
	    
	      for(var i in arr){
		this.cell[arr[i][0]][arr[i][1]].backgroundColor = "rgba(140,20,20,0.7)";
	      }
	      
	    },
	    insertBlocksFirstRow:function(){
	      for(var c=0;c<this.col;c++){
	      
		if(this.cell[0][c] == undefined){
		  
		  var spr = new Sprite(80,80);
		  spr.x = c*80;
		  spr.y = 0;
		  spr.image = game.assets["semgrade80x80.png"];
		  if(this.blockTypes.indexOf(12) >= 0){
		    var tmp = this.blockTypes.slice(0,this.blockTypes.indexOf(12));
		    spr.frame = tmp[Math.floor(Math.random()*tmp.length)];
		  }else{
		    spr.frame = this.blockTypes[Math.floor(Math.random()*this.blockTypes.length)];
		  }
		  this.addChild(spr);
		  this.cell[0][c] = spr;
		  //spr.tl.delay(Math.floor(Math.random()*100)+100).scaleTo(1.2,1.2,3).scaleTo(0.9,0.9,3).scaleTo(1,1,2).loop();
		  
		}
	      }	  
	    },
	    downBlocks:function(){
	      
	      for(var r=0;r<this.row-1;r++){
		for(var c=0;c<this.col;c++){
		
		  if(this.cell[r][c] != undefined && this.iceLayer[r][c] == false){
		  
		    var i = r*this.col + c;//iterador
		    
		    if(this.cell[r+1][c] == undefined){
		      
		      var __cell__ = this.cell[r][c];
		    //-- MODE 1		  
		      this.cell[r][c].tl.moveBy(0,80,3);
		    //-- MODE 2
		      //__cell__.y += 80;
		      this.cell[r+1][c] = __cell__;
		      this.cell[r][c] = undefined;
		      
		    //--
		    }
		    
		  }		
		  
		}
	      }	    	  
	    }
	    
	  });
	  
	
	  var Plain = enchant.Class.create(enchant.Group,{
	    initialize:function(row,col,blockTypes,blockGoals,iceLayer){
	      enchant.Group.call(this);
	      this.row = row;
	      this.col = col;
	      
	      this.width = this.col*80;
	      this.height = this.row*80;
	      
	      this.x = (game.width-this.width)/2;
	      this.y = (game.height-this.height)/2;
	      
	      this.blockTypes = (blockTypes == undefined)?[0]:blockTypes;
	      this.cell = [];
	      this.iceLayer = [];
	      
	      this.path = [];
	      this.frame = -1;
	      this.unInk = false;
	      
	      this.blockGoalsPosX = [];
	      this.blockGoalsPosY = 20;
	      
	      this.blockGoals = blockGoals;
	      this.validTypeGoals = [];
	      this.moves = 0;
	      
	      for(var r=0;r<this.row;r++){
		var __cell__ = [];
		var __ice__ = [];
		for(var c=0;c<this.col;c++){
		  __cell__.push(undefined);
		  __ice__.push(false);
		  
		}
		this.cell.push(__cell__);
		this.iceLayer.push(__ice__);
	      }
	      
	      this.iceLayerCounter = 0;
	      for(var i=0;i<iceLayer.length;i++){
		this.iceLayer[iceLayer[i][0]][iceLayer[i][1]] = true;
		this.iceLayerCounter++;
	      }
	      
	      this.iceLayerBefore = new Group();
	      this.iceLayerBefore.width = this.width;
	      this.iceLayerBefore.height = this.height;
	      this.addChild(this.iceLayerBefore);
	      
	      var bg = new Label();
	      bg.backgroundColor = "rgba(0,0,0,0.7)";
	      bg.width = this.width;
	      bg.height = this.height;
	      this.addChild(bg);
	      
	      this.iceLayerAfter = new Group();
	      this.iceLayerAfter.x = this.x;
	      this.iceLayerAfter.y = this.y;
	      this.iceLayerAfter.width = this.width;
	      this.iceLayerAfter.height = this.height;
	      //this.addChild(this.iceLayerAfter);
	      
	      this.witch = undefined;
	      
	      //console.log(this.row,this.col,this.x,this.y,this.width,this.height,this.blockTypes,this.cell,this.iceLayer);
	      game.rootScene.addChild(this);
	      game.rootScene.addChild(this.iceLayerAfter);
	      this.goals();
	      this.movesLabel();
	      this.pathLengthLabel();
	      this.refreshIceLayer();
	      this.buttons();
	      
	    },
	    turnOn:function(){
	    
	      for(var r=0;r<this.row;r++){
		for(var c=0;c<this.col;c++){
		
		  if(this.cell[r][c] != undefined && this.iceLayer[r][c] == false && this.cell[r][c].frame != 15){
		    
		    this.cell[r][c].backgroundColor = 'rgba(200,200,40,0.7)';
		    
		  }
		
		}
	      }
	    
	    },
	    turnOff:function(){
	    
	      for(var r=0;r<this.row;r++){
		for(var c=0;c<this.col;c++){
		
		  if(this.cell[r][c] != undefined && this.iceLayer[r][c] == false && this.cell[r][c].frame != 15){
		    
		    this.cell[r][c].backgroundColor = 'rgba(0,0,0,0)';
		    
		  }
		
		}
	      }
	    
	    },
	    noIce:function(){
	    
	      var condition = false;
	    
	      for(var r=0;r<this.row;r++){
		for(var c=0;c<this.col;c++){
		
		  if ( this.iceLayer[r][c] == true){
		    condition = true;
		  }
		}
	      }
	      
	      if(condition == false){
	      
		alert("Nao ha gelo neste level!");
		return;
	      
	      }
	      
	      if ((confirm("Retirar todo o gelo. \n Custo: "+__COST_NO_ICE__+" scores. \n Seu score: "+score)) && score >= __COST_NO_ICE__) {
		score -= __COST_NO_ICE__;
	      }else{
		return;
	      }
	      
	      for(var r=0;r<this.row;r++){
		for(var c=0;c<this.col;c++){
		  this.iceLayer[r][c] = false;
		}
	      }
	      
	      this.refreshIceLayer();
	    
	    },
	    removeOne:function(b){
	    
	      if(this.cell[b[0]][b[1]] != undefined && this.iceLayer[b[0]][b[1]] == false && this.cell[b[0]][b[1]].frame != 15){
		this.takeCell(b);
	      }
	    
	    },
	    collectSame:function(b){
	    
	      if(this.cell[b[0]][b[1]] != undefined && this.iceLayer[b[0]][b[1]] == false && this.cell[b[0]][b[1]].frame != 15){
	      
		var frame = this.cell[b[0]][b[1]].frame;
		
		for(var r=0;r<this.row;r++){		
		  for(var c=0;c<this.col;c++){
		  
		    if(this.cell[r][c] != undefined && this.cell[r][c].frame == frame && this.cell[r][c] != undefined && this.iceLayer[r][c] == false && this.cell[r][c].frame != 15){		    
		      this.takeCell([r,c]);
		    }
		  }		
		}
	      		
	      }
	    
	    },
	    changeCells:function(cell1,cell2){
	      
	      var tmp = this.cell[cell1[0]][cell1[1]].frame;
	      this.cell[cell1[0]][cell1[1]].frame = this.cell[cell2[0]][cell2[1]].frame;
	      this.cell[cell2[0]][cell2[1]].frame = tmp;
	      
	      this.cell[cell1[0]][cell1[1]].visible = false;
	      this.cell[cell2[0]][cell2[1]].visible = false;
	      
	      var obj1 = this.cell[cell1[0]][cell1[1]];
	      var obj2 = this.cell[cell2[0]][cell2[1]];
	      
	      var clone;
	      
	      clone = new Sprite(this.cell[cell1[0]][cell1[1]].width,this.cell[cell1[0]][cell1[1]].height);
	      clone.x = this.x+this.cell[cell1[0]][cell1[1]].x;
	      clone.y = this.y+this.cell[cell1[0]][cell1[1]].y;
	      clone.image = this.cell[cell1[0]][cell1[1]].image;
	      clone.frame = this.cell[cell1[0]][cell1[1]].frame;
	      
	      game.rootScene.addChild(clone);
	      
	      clone.tl.delay(1+Math.floor(Math.random()*3)).moveTo(this.x+this.cell[cell2[0]][cell2[1]].x,this.y+this.cell[cell2[0]][cell2[1]].y,3).then(function(){
		obj2.visible = true;
		game.rootScene.removeChild(this);
	      });
	      
	      clone = new Sprite(this.cell[cell2[0]][cell2[1]].width,this.cell[cell2[0]][cell2[1]].height);
	      clone.x = this.x+this.cell[cell2[0]][cell2[1]].x;
	      clone.y = this.y+this.cell[cell2[0]][cell2[1]].y;
	      clone.image = this.cell[cell2[0]][cell2[1]].image;
	      clone.frame = this.cell[cell2[0]][cell2[1]].frame;
	      
	      game.rootScene.addChild(clone);
	      
	      clone.tl.delay(1+Math.floor(Math.random()*3)).moveTo(this.x+this.cell[cell1[0]][cell1[1]].x,this.y+this.cell[cell1[0]][cell1[1]].y,3).then(function(){
		obj1.visible = true;
		game.rootScene.removeChild(this);
	      });
	    
	    },
	    randomCells:function(){
	    
	      if ((confirm("Deseja embaralhar o tabuleiro? \n Custo: "+__COST_RANDOM__+" scores. \n Seu score: "+score)) && score >= __COST_RANDOM__) {
		score -= __COST_RANDOM__;
	      }else{
		return;
	      }
	      
	      var possibles = [];
	      
	      for(var r=0;r<this.row;r++){
		for(var c=0;c<this.col;c++){
		  //if(this.cell[r][c] != undefined){
		  if(this.cell[r][c] != undefined && this.cell[r][c].frame != 15 && this.iceLayer[r][c] == false){
		    possibles.push([r,c]);
		  }
		}
	      }
	      
	      
	      //idea: take an element which have 3 or more.
	      //put their in 0,1,2 positions possibles
	      //never will to stay out moves!!
	      
// 	      var possiblePath = [
// 		[['r','c'],['r','c+1'],['r','c+2']],
// 		[['r','c'],['r+1','c'],['r+2','c']],
// 		[['r','c'],['r+1','c'],['r+1','c+1']],
// 		[['r','c'],['r+1','c+1'],['r+2','c+2']],
// 		[['r','c'],['r-1','c+1'],['r-1','c+2']]
// 	      ];
	      
// 	      for(var i in possibles){
// 		var r = possibles[i][0];
// 		var c = possibles[i][1];
// 		
// 	      }
	      
	      var frameElements = possibles.map(function(p){return plain.cell[p[0]][p[1]].frame;});
	      var frameElementsSort = (frameElements.map(function(k){return k;})).sort();
	      var frameElementsCount = frameElementsSort.map(function(p){return [p,count(frameElementsSort,p)]});
	      
	      for(var i in frameElementsCount){
		if(frameElementsCount[i][1] >= 3){
		  
		  var pos,r1,r2;
		  var dpos = 0;
		  //--1
		  
		  pos = frameElements.indexOf(frameElementsCount[i][0],dpos);
		  dpos = pos+1;		  
		  r1 = possibles[pos];
		  r2 = possibles[0];
		  this.changeCells(r1,r2);
		  
		  //--2
		  
		  pos = frameElements.indexOf(frameElementsCount[i][0],dpos);
		  dpos = pos+1;		  
		  r1 = possibles[pos];
		  r2 = possibles[1];
		  this.changeCells(r1,r2);
		  
		  //--3
		  
		  pos = frameElements.indexOf(frameElementsCount[i][0],dpos);
		  dpos = pos+1;		  
		  r1 = possibles[pos];
		  r2 = possibles[2];
		  this.changeCells(r1,r2);
		  
		  //--
		  possibles.splice(0,1);
		  possibles.splice(0,1);
 		  possibles.splice(0,1);
		  
		  break;
		}
	      }
	      
	      var limit = 50000;
	      
	      while((limit-- >= 0) && possibles.length > 1){
	      
		var r1 = possibles[Math.floor(Math.random()*possibles.length)];
		var r2 = possibles[Math.floor(Math.random()*possibles.length)];
		
		if(r1 != r2){
		
		  this.changeCells(r1,r2);
		  //console.log("change = ",r1," com ",r2);
		  possibles.splice(possibles.indexOf(r1),1);
		  possibles.splice(possibles.indexOf(r2),1);
		
		}
		
	      
	      }
		
	      
	    
	    },
	    buttons:function(){
	      
	      back({x:10,y:game.height-10-80,scale:0.8});
	      restart({x:90,y:game.height-10-80,scale:0.8});
	      music({x:12,y:game.height-10-80-70,scale:0.7});
	      if(this.iceLayerCounter > 0){
		noIce({x:230,y:game.height-10-80,scale:0.7});
	      }
	      if(levelActual > 50){
		removeOne({x:310,y:game.height-10-80,scale:0.7});
	      }
	      if(levelActual > 75){
		collectSame({x:395,y:game.height-10-80,scale:0.8});
	      }
	      
	    },
	    absorb:function(arr){
	      
	      var k = 0;
	      for(var i in arr){
	      
		if(this.cell[arr[i][0]][arr[i][1]] != undefined){
		
		    var clone = new Sprite(80,80);
		    clone.x = plain.x+this.cell[arr[i][0]][arr[i][1]].x;
		    clone.y = plain.y+this.cell[arr[i][0]][arr[i][1]].y;
		    clone.image = this.cell[arr[i][0]][arr[i][1]].image;
		    clone.frame = this.cell[arr[i][0]][arr[i][1]].frame;
		    game.rootScene.addChild(clone);

		    plain.cell[arr[i][0]][arr[i][1]]._visible = false;
		    
		    clone.tl.
		    scaleTo(1.0,1.0,1).rotateBy(45,2,undefined).
		    scaleTo(0.9,0.9,1).rotateBy(45,2,undefined).
		    scaleTo(0.8,0.8,1).rotateBy(45,1,undefined).
		    scaleTo(0.7,0.7,1).rotateBy(45,1,undefined).
		    scaleTo(0.6,0.6,1).rotateBy(45,1,undefined).
		    scaleTo(0.5,0.5,1).rotateBy(45,1,undefined).
		    scaleTo(0.4,0.4,1).rotateBy(45,1,undefined).
		    scaleTo(0.3,0.3,1).rotateBy(45,1,undefined).
		    then(function(){
		      plain.removeChild(plain.cell[arr[k][0]][arr[k][1]]);
		      plain.cell[arr[k][0]][arr[k][1]] = undefined;
		      game.rootScene.removeChild(this);
		      k++;
		    });
		}
	      
	      }
	      
	      plain.inkCells([]);
	      
	    
	    },		      
	    specialTile:function(p){
	    
	      var s = new Sprite(80,80);
	      s.image = game.assets["specialTile.png"];
	      //s.frame = [0,0,0,0,1,1,1,1,2,2,2,2];
	      s.frame = 0;
	      s.x = p[1]*80;
	      s.y = p[0]*80;
	      this.addChild(s);
	      s.tl.fadeOut(15).then(function(){
		plain.removeChild(this);
	      });
	    
	    },
	    watermelon:function(p){
	    
	      var r = p[0];
	      var c = p[1];
		      
	      var spr = new Sprite(107,80);
	      spr.image = game.assets["WatermelonSpecial107x80.png"];
	      spr.frame = [0,0,1,1,2,2,3,3,4,4];
	      spr.x = plain.x+c*80-(107-80)/2;
	      spr.y = plain.y+r*80;
	      game.rootScene.addChild(spr);
	      
	      spr.tl.scaleTo(1.5,1.5,5).scaleTo(1.2,1.2,5).then(function(){
		game.rootScene.removeChild(this);	    
	      });
	      
	      var lbl = new Sprite(200,23);
	      lbl.image = game.assets["MessageBombWatermelon200x23.png"];
	      lbl.frame = 0;
	      lbl.x = (game.width-200)/2;
	      lbl.y = (game.height-23)/2;
	      lbl.scaleX = 2;
	      lbl.scaleY = 2;
	      game.rootScene.addChild(lbl);
	      
	      lbl.tl.scaleTo(2.5,3.8,12).moveBy(0,12,10).scaleTo(2,2,5).moveTo(lbl.x,0,5).then(function(){
		game.rootScene.removeChild(this);	    
	      });
	      
	      this.tl.delay(10).then(function(){
		var arr = [
		  [r-1,c-1],[r-1,c],[r-1,c+1],
		  [r,c-1],[r,c],[r,c+1],
		  [r+1,c-1],[r+1,c],[r+1,c+1]
		];
		
		for(var i in arr){
		  if(arr[i][0] > -1 && arr[i][0] < this.row && arr[i][1] > -1 && arr[i][1] < this.col && this.cell[arr[i][0]][arr[i][1]] != undefined){
		    if(this.iceLayer[arr[i][0]][arr[i][1]] == false){//dont take the ice cells!
		      this.specialTile(arr[i]);
		      this.takeCell(arr[i]);
		    }
		  }
		}
		
				
	      });
	      	      
	      __score__ += 5;
	      
	    },
	    pumpking:function(p){
	    
	      var r = p[0];
	      var c = p[1];
	      
	      var spr = new Sprite(26,26);
	      spr.image = game.assets["PumpkinSpecial26x26.png"];
	      spr.frame = [0,1,2,3,4,5,6,7,8,9,10,11];
	      spr.x = plain.x+c*80-(26-80)/2;
	      spr.y = plain.y+r*80;
	      spr.scaleX = 2;
	      spr.scaleY = 2;
	      game.rootScene.addChild(spr);
	      
	      spr.tl.scaleTo(2.5,2.5,6).scaleTo(2,2,6).then(function(){
		game.rootScene.removeChild(this);	    
	      });
	      
	      var lbl = new Sprite(200,26);
	      lbl.image = game.assets["MessageFlashPumpkin200x26.png"];
	      lbl.frame = 0;
	      lbl.x = (game.width-200)/2;
	      lbl.y = (game.height-26)/2;
	      lbl.scaleX = 2;
	      lbl.scaleY = 2;
	      game.rootScene.addChild(lbl);
	      
	      lbl.tl.scaleTo(2.5,3.8,12).moveBy(0,12,10).scaleTo(2,2,5).moveTo(lbl.x,0,5).then(function(){
		game.rootScene.removeChild(this);	    
	      });
	      
	      this.tl.delay(12).then(function(){
		var arr = [
		  [r,c-4],[r,c-3],[r,c-2],[r,c-1],[r,c],[r,c+1],[r,c+2],[r,c+3],[r,c+4],
		  [r-4,c],[r-3,c],[r-2,c],[r-1,c],[r+1,c],[r+2,c],[r+3,c],[r+4,c]
		];
		
		for(var i in arr){
		  if(arr[i][0] > -1 && arr[i][0] < this.row && arr[i][1] > -1 && arr[i][1] < this.col && this.cell[arr[i][0]][arr[i][1]] != undefined){
		    if(this.iceLayer[arr[i][0]][arr[i][1]] == false){//dont take the ice cells!
		      this.specialTile(arr[i]);
		      this.takeCell(arr[i]);
		    }
		  }
		}
	      });
		
	      __score__ += 10;
	    
	    },
	    check:function(){
	    
	      var nGoals = 0;
	      for(var i in this.blockGoals){
		nGoals += this.blockGoals[i];
	      }	    
	    
	      var on = 0;
	    	    
	      if(this.moves >= 0 && nGoals == 0){
	      
		on = 1;
		
		//console.log("win");
		if(levelMaxUnlocked == levelActual && levelMaxUnlocked < __monsterLevel__[__monsterLevel__.length-1][1]){
		  levelMaxUnlocked++;
		}
		levelActual = levelMaxUnlocked;
		__score__ += parseInt((this.moves*20));
		score -= (-__score__);
			
		check_wait = false;
		
		winner();		
		
		var kxx = setInterval(function(){
		  
		  if(check_wait){
		    main();
		    clearInterval(kxx);
		  }
		  
		},100);
		
// 		main();
// 		return;
	      }
	    
	      if( on != 1 && this.moves <= 0){
		//console.log("lose");
		check_wait = false;
		
		loser();		
		
		var kxx = setInterval(function(){
		  
		  if(check_wait){
		    main();
		    clearInterval(kxx);
		  }
		  
		},100);
		
		return;
	      }
	      
	      //console.log("playing");	    
	    
	    },
	    refreshIceLayer:function(){
		  
	      var len = 0;
	      
	      len = this.iceLayerBefore.childNodes.length;
	      for(var i=0;i<len;i++){
		this.iceLayerBefore.removeChild(this.iceLayerBefore.childNodes[0]);
	      }
	      
	      len = this.iceLayerAfter.childNodes.length;
	      for(var i=0;i<len;i++){
		this.iceLayerAfter.removeChild(this.iceLayerAfter.childNodes[0]);
	      }
	      
	      for(var r=0;r<this.row;r++){
		for(var c=0;c<this.col;c++){
		  var spr;
		  if(this.iceLayer[r][c] == true){
		    
		    spr = new Sprite(80,80);
		    spr.x = c*80;
		    spr.y = r*80;
		    spr.image = game.assets["ice1.3.png"];
		    spr.frame = 0;
		    this.iceLayerBefore.addChild(spr);
		    
		    spr = new Sprite(80,80);
		    spr.x = c*80;
		    spr.y = r*80;
		    spr.image = game.assets["ice1.4.png"];
		    spr.frame = 0;
		    this.iceLayerAfter.addChild(spr);
		    
		  }
		}
	      }
	    },
	    takeCell:function(b){
	      /*
		If case b appoint to ice cell, just remove this ice, otherwise remove the cell, check goals...
	      */
	      
	      if(this.iceLayer[b[0]][b[1]] == true){
	      
		this.iceLayer[b[0]][b[1]] = false;
		this.refreshIceLayer();
		game.assets["ice.wav"].play();
		
	      }else{
			
		var i = -1;
		if(this.blockTypes.indexOf(12) >= 0){
		  i = 0;
		}else{
		  for(var v in this.validTypeGoals){
		    if(this.validTypeGoals[v][0] == this.cell[b[0]][b[1]].frame){
		      i = this.validTypeGoals[v][1];
		      break;
		    }
		  }
		}
		
		if(i > -1){
			
		  var nBlock = -1;
		  if((k=this.blockTypes.indexOf(12)) >= 0){
		    nBlock = k;
		  }else{
		    for(var v in this.blockTypes){
		      //if(this.blockTypes[v] == this.cell[b[0]][b[1]].frame){
		      if(this.blockTypes[v] == this.cell[b[0]][b[1]].frame){
			nBlock = v;
			break;
		      }
		    }
		  }
		
		  var clone = new Sprite(80,80);
		  clone.x = plain.x+this.cell[b[0]][b[1]].x;
		  clone.y = plain.y+this.cell[b[0]][b[1]].y;
		  clone.image = this.cell[b[0]][b[1]].image;
		  clone.frame = this.cell[b[0]][b[1]].frame;
		  game.rootScene.addChild(clone);
		  
		  //clone.tl.moveTo(plain.blockGoalsPosY+plain.blockGoalsPosX[i],plain.blockGoalsPosY,4).scaleTo(1.2,1.2,3).scaleTo(1,1,3).then(function(){
		  clone.tl.scaleTo(1.1,1.1,4).moveTo(plain.blockGoalsPosY+plain.blockGoalsPosX[i],plain.blockGoalsPosY,4).scaleTo(1.2,1.2,3).scaleTo(1,1,3).then(function(){
		    if(plain.blockGoals[nBlock] > 0){
		      plain.blockGoals[nBlock] -= 1;
		    }
		    if(game.assets["upMonster.ogg"]._state == 0){game.assets["upMonster.ogg"].play();}
		    game.rootScene.removeChild(this);
		  });
		}
	      
		this.removeChild(this.cell[b[0]][b[1]]);
		this.cell[b[0]][b[1]] = undefined;
	      }
	      
	    },
	    pathLengthLabel:function(){
	      var bg = new Label("0");
	      bg.backgroundColor = "rgba(0,0,0,0.7)";
	      bg.width = 40;
	      bg.height = 40;
	      bg.color = "white";
	      bg.font = "35px sans-serif";
	      bg.textAlign = "center";
	      bg._visible = false;
	      game.rootScene.addChild(bg);
	      this.pathLabel = bg;
	      
	    },
	    refreshPathLengthLabel:function(){
	      var tr = this.path[this.path.length-1][0];
	      var tc = this.path[this.path.length-1][1];
	      
	      if(tc == this.cell[0].length-1 && this.cell[0].length == 6){
		this.pathLabel.x = this.x+80*(tc)-20;
	      }else{
		this.pathLabel.x = this.x+80*(1+tc)-20;
	      }
	      this.pathLabel.y = this.y+80*(1+tr)-20;
	      this.pathLabel.text = this.path.length;
	      if(this.path.length > 14){
		this.pathLabel.color = "red";		
	      }else if(this.path.length > 6){
		this.pathLabel.color = "orange";
	      }else{
		this.pathLabel.color = "white";
		
	      }
	      this.pathLabel._visible = true;
	    },
	    movesLabel:function(){
	      var bg = new Label();
	      bg.backgroundColor = "rgba(0,0,0,0.7)";
	      bg.width = 90;
	      bg.height = 50;
	      bg.x = 370;
	      bg.y = 20;
	      bg.color = "white";
	      bg.font = "44px sans-serif";
	      bg.textAlign = "center";
	      bg.on("enterframe",function(){
		if(plain.moves >= 0){
		  this.text = plain.moves;
		}
	      });
	      game.rootScene.addChild(bg);	  
	    },
	    goals:function(){
	      
	      var n = 0;
	      for(var i in this.blockGoals){
		if(this.blockGoals[i] > 0){
		  this.validTypeGoals.push([this.blockTypes[i],n]);
		  n++;
		}
	      }
	      
	      //console.log(this.validTypeGoals);
	      this.blockGoalsPosX = goalsPosX[n-1];
	      
	      var g = new Group();
	      g.x = this.blockGoalsPosY;
	      g.y = this.blockGoalsPosY;
	      g.width = 330;
	      g.height = 80;
	      
	      var bg = new Label();
	      bg.backgroundColor = "rgba(0,0,0,0.7)";
	      bg.width = g.width;
	      bg.height = g.height;
	      g.addChild(bg);
	    
	      var j = 0;
	      for(var i in this.blockGoals){
		if(this.blockGoals[i] > 0){		
		  var spr = new Sprite(80,80);
		  spr.x = this.blockGoalsPosX[j];		
		  spr.y = 0;
		  spr.image = game.assets["semgrade80x80.png"];
		  spr.frame = this.blockTypes[i];
		  spr.scale(0.8,0.8);
		  
		  g.addChild(spr);
		  
		  var num = new Label("");
		  num.x = this.blockGoalsPosX[j]+70;
		  num.y = 30;
		  num.width = 46;
		  num.height = 30;
		  num.color = "white";
		  num.textAlign = "center";
		  num.text = this.blockGoals[i];
		  num.font = "26px sans-serif";
		  num.i = i;
		  
		  num.on("enterframe",function(){
		    if(plain.blockGoals[this.i] > 0){
		      this.text = plain.blockGoals[this.i];
		    }else{
		      this.text = "ok";
		    }
		  });

		  g.addChild(num);
		  
		  j++;
		}
	      }
	      
	      game.rootScene.addChild(g);
	    
	    },
	    hasEmptyCells:function(){
	      
	      for(var c=0;c<this.col;c++){
		if(this.cell[0][c] == undefined){
		  return true;
		}
	      }
	      
	      for(var r=0;r<this.row-1;r++){
		for(var c=0;c<this.col;c++){
		  //if(this.cell[r+1][c] == undefined && this.iceLayer[r][c] == false){
		  if(this.cell[r+1][c] == undefined && this.iceLayer[r][c] == false && this.cell[r][c] != undefined){
		    return true;
		  }
		}
	      }	    
	      return false;
	      
	    },
	    hasDownCells:function(){
	      
	      for(var r=0;r<this.row-1;r++){
		for(var c=0;c<this.col;c++){
		  if(this.cell[r+1][c] == undefined && this.iceLayer[r][c] == false && this.cell[r][c] != undefined){
		    return true;
		  }
		}
	      }	    
	      return false;
	      
	    },
	    inkCells:function(arr){
	    
	      for(var r=0;r<this.row;r++){
		for(var c=0;c<this.col;c++){
		  if(this.cell[r][c] != undefined){
		    this.cell[r][c].backgroundColor = "rgba(0,0,0,0)";
		  }
		}
	      }	    
	    
	      for(var i in arr){
		if(this.cell[arr[i][0]][arr[i][1]] != undefined){
		  this.cell[arr[i][0]][arr[i][1]].backgroundColor = "rgba(140,20,20,0.7)";
		}
	      }
	      
	    },
	    insertBlocksFirstRow:function(){
	      for(var c=0;c<this.col;c++){
	      
		if(this.cell[0][c] == undefined){
		  
		  var spr = new Sprite(80,80);
		  spr.x = c*80;
		  spr.y = 0;
		  spr.image = game.assets["semgrade80x80.png"];
		  if(this.blockTypes.indexOf(12) >= 0){
		    var tmp = this.blockTypes.slice(0,this.blockTypes.indexOf(12));
		    spr.frame = tmp[Math.floor(Math.random()*tmp.length)];
		  }else{
		    spr.frame = this.blockTypes[Math.floor(Math.random()*this.blockTypes.length)];
		  }
		  this.addChild(spr);
		  this.cell[0][c] = spr;
		  //spr.tl.delay(Math.floor(Math.random()*100)+100).scaleTo(1.2,1.2,3).scaleTo(0.9,0.9,3).scaleTo(1,1,2).loop();
		  
		}
	      }	  
	    },
	    downBlocks:function(){
	      
	      for(var r=0;r<this.row-1;r++){
		for(var c=0;c<this.col;c++){
		
		  if(this.cell[r][c] != undefined && this.iceLayer[r][c] == false){
		  
		    var i = r*this.col + c;//iterador
		    
		    if(this.cell[r+1][c] == undefined){
		      
		      var __cell__ = this.cell[r][c];
		    //-- MODE 1		  
		      this.cell[r][c].tl.moveBy(0,80,3);
		    //-- MODE 2
		      //__cell__.y += 80;
		      this.cell[r+1][c] = __cell__;
		      this.cell[r][c] = undefined;
		      
		    //--
		    }
		    
		  }		
		  
		}
	      }	    	  
	    }
	    
	  });

	  var FallenPlain = enchant.Class.create(enchant.Group,{
	    initialize:function(row,col,blockTypes,blockGoals,iceLayer){
	      enchant.Group.call(this);
	      this.row = row;
	      this.col = col;
	      
	      this.width = this.col*80;
	      this.height = this.row*80;
	      
	      this.x = (game.width-this.width)/2;
	      this.y = (game.height-this.height)/2;
	      
	      this.blockTypes = (blockTypes == undefined)?[0]:blockTypes;
	      this.cell = [];
	      this.iceLayer = [];
	      
	      this.path = [];
	      this.frame = -1;
	      this.unInk = false;
	      
	      this.blockGoalsPosX = [];
	      this.blockGoalsPosY = 20;
	      
	      this.blockGoals = blockGoals;
	      this.validTypeGoals = [];
	      this.moves = 0;
	      
	      for(var r=0;r<this.row;r++){
		var __cell__ = [];
		var __ice__ = [];
		for(var c=0;c<this.col;c++){
		  __cell__.push(undefined);
		  __ice__.push(false);
		  
		}
		this.cell.push(__cell__);
		this.iceLayer.push(__ice__);
	      }
	      
	      this.iceLayerCounter = 0;
	      for(var i=0;i<iceLayer.length;i++){
		this.iceLayer[iceLayer[i][0]][iceLayer[i][1]] = true;
		this.iceLayerCounter++;
	      }
	      
	      this.iceLayerBefore = new Group();
	      this.iceLayerBefore.width = this.width;
	      this.iceLayerBefore.height = this.height;
	      this.addChild(this.iceLayerBefore);
	      
	      var bg = new Label();
	      bg.backgroundColor = "rgba(0,0,0,0.7)";
	      bg.width = this.width;
	      bg.height = this.height;
	      this.addChild(bg);
	      
	      this.iceLayerAfter = new Group();
	      this.iceLayerAfter.x = this.x;
	      this.iceLayerAfter.y = this.y;
	      this.iceLayerAfter.width = this.width;
	      this.iceLayerAfter.height = this.height;
	      //this.addChild(this.iceLayerAfter);
	      
	      this.witch = undefined;
	      
	      this.nFallens = 0;//to fall
	      
	      if( (i = this.blockTypes.indexOf(15) ) != -1 ){
		this.nFallens = this.blockGoals[i];
	      }
	      
	      this.nextRedSkull = this.row*this.col;
	      this.__nextRedSkull__ = this.nextRedSkull;
	      
	      game.rootScene.addChild(this);
	      game.rootScene.addChild(this.iceLayerAfter);
	      this.goals();
	      this.movesLabel();
	      this.pathLengthLabel();
	      this.refreshIceLayer();
	      this.buttons();
	      
	      this.message();
	      
	    },
	    turnOn:function(){
	    
	      for(var r=0;r<this.row;r++){
		for(var c=0;c<this.col;c++){
		
		  if(this.cell[r][c] != undefined && this.iceLayer[r][c] == false && this.cell[r][c].frame != 15){
		    
		    this.cell[r][c].backgroundColor = 'rgba(200,200,40,0.7)';
		    
		  }
		
		}
	      }
	    
	    },
	    turnOff:function(){
	    
	      for(var r=0;r<this.row;r++){
		for(var c=0;c<this.col;c++){
		
		  if(this.cell[r][c] != undefined && this.iceLayer[r][c] == false && this.cell[r][c].frame != 15){
		    
		    this.cell[r][c].backgroundColor = 'rgba(0,0,0,0)';
		    
		  }
		
		}
	      }
	    
	    },
	    noIce:function(){
	    
	      var condition = false;
	    
	      for(var r=0;r<this.row;r++){
		for(var c=0;c<this.col;c++){
		
		  if ( this.iceLayer[r][c] == true){
		    condition = true;
		  }
		}
	      }
	      
	      if(condition == false){
	      
		alert("Nao ha gelo neste level!");
		return;
	      
	      }
	      
	      if ((confirm("Retirar todo o gelo. \n Custo: "+__COST_NO_ICE__+" scores. \n Seu score: "+score)) && score >= __COST_NO_ICE__) {
		score -= __COST_NO_ICE__;
	      }else{
		return;
	      }
	      
	      for(var r=0;r<this.row;r++){
		for(var c=0;c<this.col;c++){
		  this.iceLayer[r][c] = false;
		}
	      }
	      
	      this.refreshIceLayer();
	    
	    },
	    removeOne:function(b){
	    
	      if(this.cell[b[0]][b[1]] != undefined && this.iceLayer[b[0]][b[1]] == false && this.cell[b[0]][b[1]].frame != 15){
		this.takeCell(b);
	      }
	    
	    },
	    collectSame:function(b){
	    
	      if(this.cell[b[0]][b[1]] != undefined && this.iceLayer[b[0]][b[1]] == false && this.cell[b[0]][b[1]].frame != 15){
	      
		var frame = this.cell[b[0]][b[1]].frame;
		
		for(var r=0;r<this.row;r++){		
		  for(var c=0;c<this.col;c++){
		  
		    if(this.cell[r][c] != undefined && this.cell[r][c].frame == frame && this.cell[r][c] != undefined && this.iceLayer[r][c] == false && this.cell[r][c].frame != 15){		    
		      this.takeCell([r,c]);
		    }
		  }		
		}
	      		
	      }
	    
	    },	    
	    changeCells:function(cell1,cell2){
	      
	      var tmp = this.cell[cell1[0]][cell1[1]].frame;
	      this.cell[cell1[0]][cell1[1]].frame = this.cell[cell2[0]][cell2[1]].frame;
	      this.cell[cell2[0]][cell2[1]].frame = tmp;
	      
	      this.cell[cell1[0]][cell1[1]].visible = false;
	      this.cell[cell2[0]][cell2[1]].visible = false;
	      
	      var obj1 = this.cell[cell1[0]][cell1[1]];
	      var obj2 = this.cell[cell2[0]][cell2[1]];
	      
	      var clone;
	      
	      clone = new Sprite(this.cell[cell1[0]][cell1[1]].width,this.cell[cell1[0]][cell1[1]].height);
	      clone.x = this.x+this.cell[cell1[0]][cell1[1]].x;
	      clone.y = this.y+this.cell[cell1[0]][cell1[1]].y;
	      clone.image = this.cell[cell1[0]][cell1[1]].image;
	      clone.frame = this.cell[cell1[0]][cell1[1]].frame;
	      
	      game.rootScene.addChild(clone);
	      
	      clone.tl.delay(1+Math.floor(Math.random()*3)).moveTo(this.x+this.cell[cell2[0]][cell2[1]].x,this.y+this.cell[cell2[0]][cell2[1]].y,3).then(function(){
		obj2.visible = true;
		game.rootScene.removeChild(this);
	      });
	      
	      clone = new Sprite(this.cell[cell2[0]][cell2[1]].width,this.cell[cell2[0]][cell2[1]].height);
	      clone.x = this.x+this.cell[cell2[0]][cell2[1]].x;
	      clone.y = this.y+this.cell[cell2[0]][cell2[1]].y;
	      clone.image = this.cell[cell2[0]][cell2[1]].image;
	      clone.frame = this.cell[cell2[0]][cell2[1]].frame;
	      
	      game.rootScene.addChild(clone);
	      
	      clone.tl.delay(1+Math.floor(Math.random()*3)).moveTo(this.x+this.cell[cell1[0]][cell1[1]].x,this.y+this.cell[cell1[0]][cell1[1]].y,3).then(function(){
		obj1.visible = true;
		game.rootScene.removeChild(this);
	      });
	    
	    },
	    randomCells:function(){
	    
	      if ((confirm("Deseja embaralhar o tabuleiro? \n Custo: "+__COST_RANDOM__+" scores. \n Seu score: "+score)) && score >= __COST_RANDOM__) {
		score -= __COST_RANDOM__;
	      }else{
		return;
	      }
	      
	      var possibles = [];
	      
	      for(var r=0;r<this.row;r++){
		for(var c=0;c<this.col;c++){
		  //if(this.cell[r][c] != undefined){
		  if(this.cell[r][c] != undefined && this.cell[r][c].frame != 15 && this.iceLayer[r][c] == false){
		    possibles.push([r,c]);
		  }
		}
	      }
	      
	      var frameElements = possibles.map(function(p){return plain.cell[p[0]][p[1]].frame;});
	      var frameElementsSort = (frameElements.map(function(k){return k;})).sort();
	      var frameElementsCount = frameElementsSort.map(function(p){return [p,count(frameElementsSort,p)]});
	      
	      for(var i in frameElementsCount){
		if(frameElementsCount[i][1] >= 3){
		  
		  var pos,r1,r2;
		  var dpos = 0;
		  //--1
		  
		  pos = frameElements.indexOf(frameElementsCount[i][0],dpos);
		  dpos = pos+1;		  
		  r1 = possibles[pos];
		  r2 = possibles[0];
		  this.changeCells(r1,r2);
		  
		  //--2
		  
		  pos = frameElements.indexOf(frameElementsCount[i][0],dpos);
		  dpos = pos+1;		  
		  r1 = possibles[pos];
		  r2 = possibles[1];
		  this.changeCells(r1,r2);
		  
		  //--3
		  
		  pos = frameElements.indexOf(frameElementsCount[i][0],dpos);
		  dpos = pos+1;		  
		  r1 = possibles[pos];
		  r2 = possibles[2];
		  this.changeCells(r1,r2);
		  
		  //--
		  possibles.splice(0,1);
		  possibles.splice(0,1);
 		  possibles.splice(0,1);
		  
		  break;
		}
	      }

	      
	      var limit = 50000;
	      
	      while((limit-- >= 0) && possibles.length > 1){
	      
		var r1 = possibles[Math.floor(Math.random()*possibles.length)];
		var r2 = possibles[Math.floor(Math.random()*possibles.length)];
		
		if(r1 != r2){
		
		  this.changeCells(r1,r2);
		  //console.log("change = ",r1," com ",r2);
		  possibles.splice(possibles.indexOf(r1),1);
		  possibles.splice(possibles.indexOf(r2),1);
		
		}
		
	      
	      }
		
	      
	    
	    },
	    message:function(){
	    
	      GAME_STATUS = 2;
	      var g = new Group();
	      g.x = -game.width;
	      g.y = (game.height-120)/2-10;
	      g.width = game.width;
	      g.height = 120;
	      
	      var l = new Label("Des\u00e7a as caveiras");
	      l.font = "40px Arial";
	      l.x = 0;
	      l.y = 0;
	      l.width = g.width;
	      l.height = g.height/2;
	      l.color = "white";
	      l.textAlign = "center";
	      l.backgroundColor = "rgba(0,0,0,0.8)";
	      g.addChild(l);
	      
	      l = new Label("Vermelhas!");
	      l.font = "52px sans-serif";
	      l.x = 0;
	      l.y = g.height/2;
	      l.width = g.width;
	      l.height = g.height/2;
	      l.color = "red";
	      l.textAlign = "center";
	      l.backgroundColor = "rgba(255,255,255,0.8)";
	      g.addChild(l);
	      
	      game.rootScene.addChild(g);
	      
	      g.tl.moveBy(game.width+25,0,8).moveBy(-25,0,5).delay(10).scaleTo(0.94,0.94,3).scaleTo(1.14,1.14,4).scaleTo(1,1,4).delay(10).moveBy(-25,0,5).moveBy(game.width+25,0,8)
	      .then(function(){
		GAME_STATUS = 1;
		game.rootScene.removeChild(this);
	      });
	    
	    },	    
	    buttons:function(){
	      
	      back({x:10,y:game.height-10-80,scale:0.8});
	      restart({x:90,y:game.height-10-80,scale:0.8});
	      music({x:12,y:game.height-10-80-70,scale:0.7});
	      if(this.iceLayerCounter > 0){
		noIce({x:230,y:game.height-10-80,scale:0.7});
	      }
	      if(levelActual > 50){
		removeOne({x:310,y:game.height-10-80,scale:0.7});
	      }
	      if(levelActual > 75){
		collectSame({x:395,y:game.height-10-80,scale:0.8});
	      }
	      
	    },
	    specialTile:function(p){
	    
	      var s = new Sprite(80,80);
	      s.image = game.assets["specialTile.png"];
	      //s.frame = [0,0,0,0,1,1,1,1,2,2,2,2];
	      s.frame = 0;
	      s.x = p[1]*80;
	      s.y = p[0]*80;
	      this.addChild(s);
	      s.tl.fadeOut(15).then(function(){
		plain.removeChild(this);
	      });
	    
	    },	    
	    watermelon:function(p){
	    
	      var r = p[0];
	      var c = p[1];
		      
	      var spr = new Sprite(107,80);
	      spr.image = game.assets["WatermelonSpecial107x80.png"];
	      spr.frame = [0,0,1,1,2,2,3,3,4,4];
	      spr.x = plain.x+c*80-(107-80)/2;
	      spr.y = plain.y+r*80;
	      game.rootScene.addChild(spr);
	      
	      spr.tl.scaleTo(1.5,1.5,5).scaleTo(1.2,1.2,5).then(function(){
		game.rootScene.removeChild(this);	    
	      });
	      
	      var lbl = new Sprite(200,23);
	      lbl.image = game.assets["MessageBombWatermelon200x23.png"];
	      lbl.frame = 0;
	      lbl.x = (game.width-200)/2;
	      lbl.y = (game.height-23)/2;
	      lbl.scaleX = 2;
	      lbl.scaleY = 2;
	      game.rootScene.addChild(lbl);
	      
	      lbl.tl.scaleTo(2.5,3.8,12).moveBy(0,12,10).scaleTo(2,2,5).moveTo(lbl.x,0,5).then(function(){
		game.rootScene.removeChild(this);	    
	      });
	      
	      this.tl.delay(10).then(function(){
		var arr = [
		  [r-1,c-1],[r-1,c],[r-1,c+1],
		  [r,c-1],[r,c],[r,c+1],
		  [r+1,c-1],[r+1,c],[r+1,c+1]
		];
		
		for(var i in arr){
		  if(arr[i][0] > -1 && arr[i][0] < this.row && arr[i][1] > -1 && arr[i][1] < this.col && this.cell[arr[i][0]][arr[i][1]] != undefined){
		    if(this.iceLayer[arr[i][0]][arr[i][1]] == false){//dont take the ice cells!
		      this.specialTile(arr[i]);
		      this.takeCell(arr[i]);
		    }
		  }
		}
		
		
		
	      });
	      
	      __score__ += 5;
	      
	    },
	    pumpking:function(p){
	    
	      var r = p[0];
	      var c = p[1];
	      
	      var spr = new Sprite(26,26);
	      spr.image = game.assets["PumpkinSpecial26x26.png"];
	      spr.frame = [0,1,2,3,4,5,6,7,8,9,10,11];
	      spr.x = plain.x+c*80-(26-80)/2;
	      spr.y = plain.y+r*80;
	      spr.scaleX = 2;
	      spr.scaleY = 2;
	      game.rootScene.addChild(spr);
	      
	      spr.tl.scaleTo(2.5,2.5,6).scaleTo(2,2,6).then(function(){
		game.rootScene.removeChild(this);	    
	      });
	      
	      var lbl = new Sprite(200,26);
	      lbl.image = game.assets["MessageFlashPumpkin200x26.png"];
	      lbl.frame = 0;
	      lbl.x = (game.width-200)/2;
	      lbl.y = (game.height-26)/2;
	      lbl.scaleX = 2;
	      lbl.scaleY = 2;
	      game.rootScene.addChild(lbl);
	      
	      lbl.tl.scaleTo(2.5,3.8,12).moveBy(0,12,10).scaleTo(2,2,5).moveTo(lbl.x,0,5).then(function(){
		game.rootScene.removeChild(this);	    
	      });
	      
	      this.tl.delay(12).then(function(){
		var arr = [
		  [r,c-4],[r,c-3],[r,c-2],[r,c-1],[r,c],[r,c+1],[r,c+2],[r,c+3],[r,c+4],
		  [r-4,c],[r-3,c],[r-2,c],[r-1,c],[r+1,c],[r+2,c],[r+3,c],[r+4,c]
		];
		
		for(var i in arr){
		  if(arr[i][0] > -1 && arr[i][0] < this.row && arr[i][1] > -1 && arr[i][1] < this.col && this.cell[arr[i][0]][arr[i][1]] != undefined){
		    if(this.iceLayer[arr[i][0]][arr[i][1]] == false){//dont take the ice cells!
		      this.specialTile(arr[i]);
		      this.takeCell(arr[i]);
		    }
		  }
		}
	      });
		
	      __score__ += 10;
	    
	    },
	    check:function(){
	    
	      var nGoals = 0;
	      for(var i in this.blockGoals){
		nGoals += this.blockGoals[i];
	      }
	      
	      var on = 0;	    
	    
	      if(this.moves >= 0 && nGoals == 0){
		
		on = 1;
		
		//console.log("win");
		if(levelMaxUnlocked == levelActual && levelMaxUnlocked < __monsterLevel__[__monsterLevel__.length-1][1]){
		  levelMaxUnlocked++;
		}
		levelActual = levelMaxUnlocked;
		__score__ += parseInt((this.moves*20));
		score -= (-__score__);
		check_wait = false;
		
		winner();		
		
		var kxx = setInterval(function(){
		  
		  if(check_wait){
		    main();
		    clearInterval(kxx);
		  }
		  
		},100);
	      }
	    
	      if(on != 1 && this.moves <= 0){
		//console.log("lose");
		check_wait = false;
		
		loser();		
		
		var kxx = setInterval(function(){
		  
		  if(check_wait){
		    main();
		    clearInterval(kxx);
		  }
		  
		},100);
	      }
	      
	      //console.log("playing");	    
	    
	    },
	    refreshIceLayer:function(){
		  
	      var len = 0;
	      
	      len = this.iceLayerBefore.childNodes.length;
	      for(var i=0;i<len;i++){
		this.iceLayerBefore.removeChild(this.iceLayerBefore.childNodes[0]);
	      }
	      
	      len = this.iceLayerAfter.childNodes.length;
	      for(var i=0;i<len;i++){
		this.iceLayerAfter.removeChild(this.iceLayerAfter.childNodes[0]);
	      }
	      
	      for(var r=0;r<this.row;r++){
		for(var c=0;c<this.col;c++){
		  var spr;
		  if(this.iceLayer[r][c] == true){
		    
		    spr = new Sprite(80,80);
		    spr.x = c*80;
		    spr.y = r*80;
		    spr.image = game.assets["ice1.3.png"];
		    spr.frame = 0;
		    this.iceLayerBefore.addChild(spr);
		    
		    spr = new Sprite(80,80);
		    spr.x = c*80;
		    spr.y = r*80;
		    spr.image = game.assets["ice1.4.png"];
		    spr.frame = 0;
		    this.iceLayerAfter.addChild(spr);
		    
		  }
		}
	      }
	    },
	    takeRedCell:function(cell){
	    
		var b = [];
	    
		for(var r=0;r<this.row;r++){
		  for(var c=0;c<this.col;c++){
		    if(cell == this.cell[r][c]){
		      b = [r,c];
		      break;
		    }
		  }
		}
	    
		var i = 0;
		for(var v in this.validTypeGoals){
		  if(this.validTypeGoals[v][0] == 15){
		    i = this.validTypeGoals[v][1];
		    break;
		  }
		}
		      
		var clone = new Sprite(80,80);
		clone.x = plain.x+this.cell[b[0]][b[1]].x;
		clone.y = plain.y+this.cell[b[0]][b[1]].y;
		clone.image = this.cell[b[0]][b[1]].image;
		clone.frame = this.cell[b[0]][b[1]].frame;
		game.rootScene.addChild(clone);
		
		//clone.tl.moveTo(plain.blockGoalsPosY+plain.blockGoalsPosX[i],plain.blockGoalsPosY,4).scaleTo(1.2,1.2,3).scaleTo(1,1,3).then(function(){
		clone.tl.scaleTo(1.1,1.1,4).moveTo(plain.blockGoalsPosY+plain.blockGoalsPosX[i],plain.blockGoalsPosY,8).scaleTo(1.2,1.2,3).scaleTo(1,1,3).then(function(){
		  var nBlock = plain.blockTypes.indexOf(15);
		  if(plain.blockGoals[nBlock] > 0){
		    plain.blockGoals[nBlock] -= 1;
		  }
		  if(game.assets["upMonster.ogg"]._state == 0){game.assets["upMonster.ogg"].play();}
		  game.rootScene.removeChild(this);
		});
	    
		this.removeChild(this.cell[b[0]][b[1]]);
		this.cell[b[0]][b[1]] = undefined;
	    
	    
	    },
	    takeCell:function(b){
	      /*
		If case b appoint to ice cell, just remove this ice, otherwise remove the cell, check goals...
	      */
	      
	      if(this.iceLayer[b[0]][b[1]] == true){
	      
		this.iceLayer[b[0]][b[1]] = false;
		this.refreshIceLayer();
		game.assets["ice.wav"].play();
		
	      }else{
		
		if(this.cell[b[0]][b[1]] != undefined && this.cell[b[0]][b[1]].frame != 15 && this.frame != 15){
		
		
		    var i = -1;
		    if(this.blockTypes.indexOf(12) >= 0){
		      i = 0;
		    }else{
		      for(var v in this.validTypeGoals){
			if(this.validTypeGoals[v][0] == this.cell[b[0]][b[1]].frame){
			  i = this.validTypeGoals[v][1];
			  break;
			}
		      }
		    }
		    
		    if(i > -1){
			    
		      var nBlock = -1;
		      if((k=this.blockTypes.indexOf(12)) >= 0){
			nBlock = k;
		      }else{
			for(var v in this.blockTypes){
			  //if(this.blockTypes[v] == this.cell[b[0]][b[1]].frame){
			  if(this.blockTypes[v] == this.cell[b[0]][b[1]].frame){
			    nBlock = v;
			    break;
			  }
			}
		      }
		    
		      var clone = new Sprite(80,80);
		      clone.x = plain.x+this.cell[b[0]][b[1]].x;
		      clone.y = plain.y+this.cell[b[0]][b[1]].y;
		      clone.image = this.cell[b[0]][b[1]].image;
		      clone.frame = this.cell[b[0]][b[1]].frame;
		      game.rootScene.addChild(clone);
		      
		      //clone.tl.moveTo(plain.blockGoalsPosY+plain.blockGoalsPosX[i],plain.blockGoalsPosY,4).scaleTo(1.2,1.2,3).scaleTo(1,1,3).then(function(){
		      clone.tl.scaleTo(1.1,1.1,4).moveTo(plain.blockGoalsPosY+plain.blockGoalsPosX[i],plain.blockGoalsPosY,4).scaleTo(1.2,1.2,3).scaleTo(1,1,3).then(function(){
			if(plain.blockGoals[nBlock] > 0){
			  plain.blockGoals[nBlock] -= 1;
			}
			if(game.assets["upMonster.ogg"]._state == 0){game.assets["upMonster.ogg"].play();}
			game.rootScene.removeChild(this);
		      });
		    }
		  
		    this.removeChild(this.cell[b[0]][b[1]]);
		    this.cell[b[0]][b[1]] = undefined;
		    
		    
		  }else{
		
		  }		  
		  
		  
		  
		}
		
	      
	    },
	    pathLengthLabel:function(){
	      var bg = new Label("0");
	      bg.backgroundColor = "rgba(0,0,0,0.7)";
	      bg.width = 40;
	      bg.height = 40;
	      bg.color = "white";
	      bg.font = "35px sans-serif";
	      bg.textAlign = "center";
	      bg._visible = false;
	      game.rootScene.addChild(bg);
	      this.pathLabel = bg;
	      
	    },
	    refreshPathLengthLabel:function(){
	    
	      if(this.path[this.path.length-1] != undefined){
	      
		var tr = this.path[this.path.length-1][0];
		var tc = this.path[this.path.length-1][1];
		
		if(tc == this.cell[0].length-1 && this.cell[0].length == 6){
		  this.pathLabel.x = this.x+80*(tc)-20;
		}else{
		  this.pathLabel.x = this.x+80*(1+tc)-20;
		}
		this.pathLabel.y = this.y+80*(1+tr)-20;
		this.pathLabel.text = this.path.length;
		if(this.path.length > 14){
		  this.pathLabel.color = "red";		
		}else if(this.path.length > 6){
		  this.pathLabel.color = "orange";
		}else{
		  this.pathLabel.color = "white";
		  
		}
		this.pathLabel._visible = true;
	      
	      }
	    
	    },
	    movesLabel:function(){
	      var bg = new Label();
	      bg.backgroundColor = "rgba(0,0,0,0.7)";
	      bg.width = 90;
	      bg.height = 50;
	      bg.x = 370;
	      bg.y = 20;
	      bg.color = "white";
	      bg.font = "44px sans-serif";
	      bg.textAlign = "center";
	      bg.on("enterframe",function(){
		if(plain.moves >= 0){
		  this.text = plain.moves;
		}
	      });
	      game.rootScene.addChild(bg);	  
	    },
	    goals:function(){
	      
	      var n = 0;
	      for(var i in this.blockGoals){
		if(this.blockGoals[i] > 0){
		  this.validTypeGoals.push([this.blockTypes[i],n]);
		  n++;
		}
	      }
	      
	      //console.log(this.validTypeGoals);
	      this.blockGoalsPosX = goalsPosX[n-1];
	      
	      var g = new Group();
	      g.x = this.blockGoalsPosY;
	      g.y = this.blockGoalsPosY;
	      g.width = 330;
	      g.height = 80;
	      
	      var bg = new Label();
	      bg.backgroundColor = "rgba(0,0,0,0.7)";
	      bg.width = g.width;
	      bg.height = g.height;
	      g.addChild(bg);
	    
	      var j = 0;
	      for(var i in this.blockGoals){
		if(this.blockGoals[i] > 0){		
		  var spr = new Sprite(80,80);
		  spr.x = this.blockGoalsPosX[j];		
		  spr.y = 0;
		  spr.image = game.assets["semgrade80x80.png"];
		  spr.frame = this.blockTypes[i];
		  spr.scale(0.8,0.8);
		  
		  g.addChild(spr);
		  
		  var num = new Label("");
		  num.x = this.blockGoalsPosX[j]+70;
		  num.y = 30;
		  num.width = 46;
		  num.height = 30;
		  num.color = "white";
		  num.textAlign = "center";
		  num.text = this.blockGoals[i];
		  num.font = "26px sans-serif";
		  num.i = i;
		  
		  num.on("enterframe",function(){
		    if(plain.blockGoals[this.i] > 0){
		      this.text = plain.blockGoals[this.i];
		    }else{
		      this.text = "ok";
		    }
		  });

		  g.addChild(num);
		  
		  j++;
		}
	      }
	      
	      game.rootScene.addChild(g);
	    
	    },
	    hasEmptyCells:function(){
	      
	      for(var c=0;c<this.col;c++){
		if(this.cell[0][c] == undefined){
		  return true;
		}
	      }
	      
	      for(var r=0;r<this.row-1;r++){
		for(var c=0;c<this.col;c++){
		  //if(this.cell[r+1][c] == undefined && this.iceLayer[r][c] == false){
		  if(this.cell[r+1][c] == undefined && this.iceLayer[r][c] == false && this.cell[r][c] != undefined){
		    return true;
		  }
		}
	      }	    
	      return false;
	      
	    },
	    hasDownCells:function(){
	      
	      for(var r=0;r<this.row-1;r++){
		for(var c=0;c<this.col;c++){
		  if(this.cell[r+1][c] == undefined && this.iceLayer[r][c] == false && this.cell[r][c] != undefined){
		    return true;
		  }
		}
	      }	    
	      return false;
	      
	    },
	    inkCells:function(arr){
	    
	      for(var r=0;r<this.row;r++){
		for(var c=0;c<this.col;c++){
		  if(this.cell[r][c] != undefined){
		    this.cell[r][c].backgroundColor = "rgba(0,0,0,0)";
		  }
		}
	      }	    
	    
	      for(var i in arr){
		if(this.cell[arr[i][0]][arr[i][1]] != undefined){
		  this.cell[arr[i][0]][arr[i][1]].backgroundColor = "rgba(140,20,20,0.7)";
		}
	      }
	      
	    },
	    insertBlocksFirstRow:function(){
	      for(var c=0;c<this.col;c++){
	      
		if(this.cell[0][c] == undefined){
		  
		  var spr = new Sprite(80,80);
		  spr.x = c*80;
		  spr.y = 0;
		  spr.image = game.assets["semgrade80x80.png"];
		  if(this.blockTypes.indexOf(12) >= 0){
		    var tmp = this.blockTypes.slice(0,this.blockTypes.indexOf(12));
		    spr.frame = tmp[Math.floor(Math.random()*tmp.length)];
		  }else{
		    //spr.frame = this.blockTypes[Math.floor(Math.random()*this.blockTypes.length)];		    
		    if(this.nextRedSkull-- == 0 && this.nFallens > 0){
		      spr.frame = this.blockTypes[this.blockTypes.length-1];
		      this.nextRedSkull = this.__nextRedSkull__;
		      this.nFallens -= 1;
		    }else{
		      spr.frame = this.blockTypes[Math.floor(Math.random()*(this.blockTypes.length-1))];
		    }
		  }
		  this.addChild(spr);
		  this.cell[0][c] = spr;
		  //spr.tl.delay(Math.floor(Math.random()*100)+100).scaleTo(1.2,1.2,3).scaleTo(0.9,0.9,3).scaleTo(1,1,2).loop();
		  
		}
	      }	  
	    },
	    downBlocks:function(){
	      
	      for(var r=0;r<this.row-1;r++){
		for(var c=0;c<this.col;c++){
		
		  if(this.cell[r][c] != undefined && this.iceLayer[r][c] == false){
		  
		    var i = r*this.col + c;//iterador
		    
		    if(this.cell[r+1][c] == undefined){
		      
		      var __cell__ = this.cell[r][c];
		    //-- MODE 1		  
		      //this.cell[r][c].tl.moveBy(0,80,3);
		      this.cell[r][c].tl.moveBy(0,80,3).then(function(){
			if(this.frame == 15 && parseInt(this.y + 80) == parseInt(plain.height)){
			  plain.takeRedCell(this);
			}
			
		      });
		    //-- MODE 2
		      //__cell__.y += 80;
		      this.cell[r+1][c] = __cell__;
		      this.cell[r][c] = undefined;
		      
		    //--
		    }
		    
		  }		
		  
		}
	      }	    	  
	    }
	    
	  });
	  
	  var CannonPlain = enchant.Class.create(enchant.Group,{
	    initialize:function(row,col,blockTypes,blockGoals,iceLayer,cannon){//cannon = [[r,c,0,-1],..]
	      enchant.Group.call(this);
	      this.row = row;
	      this.col = col;
	      
	      this.width = this.col*80;
	      this.height = this.row*80;
	      
	      this.x = (game.width-this.width)/2;
	      this.y = (game.height-this.height)/2;
	      
	      this.blockTypes = (blockTypes == undefined)?[0]:blockTypes;
	      this.cell = [];
	      this.iceLayer = [];
	      
	      this.cannon = cannon;
	      this.shotCannonBusy = false;
	      this.createCannon();
	      
	      this.path = [];
	      this.frame = -1;
	      this.unInk = false;
	      
	      this.blockGoalsPosX = [];
	      this.blockGoalsPosY = 20;
	      
	      this.blockGoals = blockGoals;
	      this.validTypeGoals = [];
	      this.moves = 0;
	      
	      for(var r=0;r<this.row;r++){
		var __cell__ = [];
		var __ice__ = [];
		for(var c=0;c<this.col;c++){
		  __cell__.push(undefined);
		  __ice__.push(false);
		  
		}
		this.cell.push(__cell__);
		this.iceLayer.push(__ice__);
	      }
	      
	      this.iceLayerCounter = 0;
	      for(var i=0;i<iceLayer.length;i++){
		this.iceLayer[iceLayer[i][0]][iceLayer[i][1]] = true;
		this.iceLayerCounter++;
	      }
	      
	      this.iceLayerBefore = new Group();
	      this.iceLayerBefore.width = this.width;
	      this.iceLayerBefore.height = this.height;
	      this.addChild(this.iceLayerBefore);
	      
	      var bg = new Label();
	      bg.backgroundColor = "rgba(0,0,0,0.7)";
	      bg.width = this.width;
	      bg.height = this.height;
	      this.addChild(bg);
	      
	      this.iceLayerAfter = new Group();
	      this.iceLayerAfter.x = this.x;
	      this.iceLayerAfter.y = this.y;
	      this.iceLayerAfter.width = this.width;
	      this.iceLayerAfter.height = this.height;
	      //this.addChild(this.iceLayerAfter);
	      
	      //console.log(this.row,this.col,this.x,this.y,this.width,this.height,this.blockTypes,this.cell,this.iceLayer);
	      game.rootScene.addChild(this);
	      game.rootScene.addChild(this.iceLayerAfter);
	      this.goals();
	      this.movesLabel();
	      this.pathLengthLabel();
	      this.refreshIceLayer();
	      this.buttons();
	      
	    },	    
	    createCannon:function(){
	    
	      for(var i=0;i<this.cannon.length;i++){
		var spr = new Sprite(70,63);
		spr.x = this.cannon[i][1]*80 + (80-spr.width)/2;
		spr.y = this.cannon[i][0]*80 + (80-spr.height)/2;
		spr.image = game.assets["cannon.png"];
		spr.frame = 0;
		this.addChild(spr);
		
		//--dir
		var r = this.cannon[i][2];
		var c = this.cannon[i][3];
		if(r == -1 && c == 0){
		  //pass
		}else if((r == -1 && c == 1) || (r == 0 && c == 1)){
		  spr.rotate(90);
		}else if((r == -1 && c == -1) || (r == 0 && c == -1)){
		  spr.rotate(-90);
		}else if(r == 1 && c == 0){
		  spr.rotate(180);
		}
		//--
		
	      }
	    
	    },
	    shotCannon:function(){
	    
	      /*
	      if(this.shotCannonBusy == true){
		return false;
	      }
	      
	      for(var i=0;i<this.cannon.length;i++){
		
		GAME_STATUS = 2;
		this.shotCannonBusy = true;
		
		var _cannon_ = this.cannon[i];
		var r = _cannon_[0] + _cannon_[2];
		var c = _cannon_[1] + _cannon_[3];
		
		for(var j=r;j>=0;j--){
		  if(this.cell[r][c] != undefined && this.iceLayer[r][c] == false){
		    this.removeChild(this.cell[r][c]);
		    this.cell[r][c] = undefined;		
		    r = r + _cannon_[2];
		    c = c + _cannon_[3];
		  }
		}
		
		GAME_STATUS = 1;
		this.shotCannonBusy = false;
		
	      }
	      */
	      if(this.shotCannonBusy == true){
		return false;
	      }
	      
	      for(var i=0;i<this.cannon.length;i++){
		
		GAME_STATUS = 2;
		this.shotCannonBusy = true;
		
		var _cannon_ = this.cannon[i];
		var r = _cannon_[0] + _cannon_[2];
		var c = _cannon_[1] + _cannon_[3];
		
		//--
		
		var rMax = 0;
		var cMax = 0;
		
		//--dir
		var rm = this.cannon[i][2];
		var cm = this.cannon[i][3];		
		if(rm == -1 && cm == 0){
		  for(var j=r;j>=0;j--){
		    if(this.cell[j][c] == undefined || this.iceLayer[j][c] == true){
		      rMax = j;
		      break;
		    }
		  }		  		  
		}else if((rm == -1 && cm == 1) || (rm == 0 && cm == 1)){
		  for(var j=c;j<this.col;j++){
		    if(this.cell[r][j] == undefined || this.iceLayer[r][j] == true){
		      cMax = j;
		      break;
		    }
		    cMax = j;
		  }		  
		}else if((rm == -1 && cm == -1) || (rm == 0 && cm == -1)){
		  for(var j=c;j>=0;j--){
		    if(this.cell[r][j] == undefined || this.iceLayer[r][j] == true){
		      cMax = j;
		      break;
		    }
		  }		  		  		  
		}else if(rm == 1 && cm == 0){
		  for(var j=r;j<this.row;j++){
		    if(this.cell[j][c] == undefined || this.iceLayer[j][c] == true){
		      rMax = j;
		      break;
		    }
		    rMax = j;
		  }		  		  		  
		}
		//--
		
		var shot = new Sprite(30,28);
		shot.x = c * 80 + (80-30)/2;
		shot.y = r * 80 + (80-28)/2;
		shot.image = game.assets["shot.png"];
		shot.frame = 1;
		this.addChild(shot);
		//shot.tl.moveTo(shot.x,rMax * 80,5-rMax+1).then(function(){
		if(rm == -1 && cm == 0){
		  shot.tl.moveTo(shot.x,rMax * 80,5-rMax+1).then(function(){
		    plain.removeChild(this);
		  });
		}else if((rm == -1 && cm == 1) || (rm == 0 && cm == 1)){
		  shot.tl.moveTo(cMax * 80,shot.y,5-rMax+1).then(function(){
		    plain.removeChild(this);
		  });
		}else if((rm == -1 && cm == -1) || (rm == 0 && cm == -1)){
		  shot.tl.moveTo(cMax * 80,shot.y,5-rMax+1).then(function(){
		    plain.removeChild(this);
		  });
		}else if(rm == 1 && cm == 0){
		  shot.tl.moveTo(shot.x,rMax * 80,5-rMax+1).then(function(){
		    plain.removeChild(this);
		  });
		}
		
		//--
		
		for(var j=r;j>=0;j--){
		  if(this.cell[r][c] != undefined && this.iceLayer[r][c] == false){
		    
		    //--
		    var clone = new Sprite(80,80);
		    clone.x = c * 80;
		    clone.y = r * 80;
		    clone.image = this.cell[r][c].image;
		    clone.frame = this.cell[r][c].frame;
		    this.addChild(clone);
		    clone.tl.fadeOut( 3 ).then(function(){
		      plain.removeChild(this);
		    });
		    //--
		    
		    this.removeChild(this.cell[r][c]);
		    this.cell[r][c] = undefined;
		    
		    r = r + _cannon_[2];
		    c = c + _cannon_[3];
		  }
		}
	    
		this.tl.delay( 4 ).then(function(){
		  GAME_STATUS = 1;
		});
		
		this.shotCannonBusy = false;
		
	      }
	      
	    },	    
	    turnOn:function(){
	    
	      for(var r=0;r<this.row;r++){
		for(var c=0;c<this.col;c++){
		
		  var shot = false;
		  for(var s=0;s<this.cannon.length;s++){
		    if(!shot && c == this.cannon[s][1] && r + 1 == this.cannon[s][0]){
		      shot = true;
		      break;
		    }
		  }
		
		  //if(this.cell[r][c] != undefined && this.iceLayer[r][c] == false && this.cell[r][c].frame != 15 ){
		  if(this.cell[r][c] != undefined && this.iceLayer[r][c] == false && this.cell[r][c].frame != 15 && !shot){
		    
		    this.cell[r][c].backgroundColor = 'rgba(200,200,40,0.7)';
		    
		  }
		
		}
	      }
	    
	    },
	    turnOff:function(){
	    
	      for(var r=0;r<this.row;r++){
		for(var c=0;c<this.col;c++){
		
		  var shot = false;
		  for(var s=0;s<this.cannon.length;s++){
		    if(!shot && c == this.cannon[s][1] && r + 1 == this.cannon[s][0]){
		      shot = true;
		      break;
		    }
		  }
		  
		  //if(this.cell[r][c] != undefined && this.iceLayer[r][c] == false && this.cell[r][c].frame != 15){
		  if(this.cell[r][c] != undefined && this.iceLayer[r][c] == false && this.cell[r][c].frame != 15 && !shot){
		    
		    this.cell[r][c].backgroundColor = 'rgba(0,0,0,0)';
		    
		  }
		
		}
	      }
	    
	    },
	    noIce:function(){
	    
	      var condition = false;
	    
	      for(var r=0;r<this.row;r++){
		for(var c=0;c<this.col;c++){
		
		  if ( this.iceLayer[r][c] == true){
		    condition = true;
		  }
		}
	      }
	      
	      if(condition == false){
	      
		alert("Nao ha gelo neste level!");
		return;
	      
	      }
	      
	      if ((confirm("Retirar todo o gelo. \n Custo: "+__COST_NO_ICE__+" scores. \n Seu score: "+score)) && score >= __COST_NO_ICE__) {
		score -= __COST_NO_ICE__;
	      }else{
		return;
	      }
	      
	      for(var r=0;r<this.row;r++){
		for(var c=0;c<this.col;c++){
		  this.iceLayer[r][c] = false;
		}
	      }
	      
	      this.refreshIceLayer();
	    
	    },
	    removeOne:function(b){
	    
	      if(this.cell[b[0]][b[1]] != undefined && this.iceLayer[b[0]][b[1]] == false && this.cell[b[0]][b[1]].frame != 15){
		this.takeCell(b);
	      }
	    
	    },
	    collectSame:function(b){
	    
	      if(this.cell[b[0]][b[1]] != undefined && this.iceLayer[b[0]][b[1]] == false && this.cell[b[0]][b[1]].frame != 15){
	      
		var frame = this.cell[b[0]][b[1]].frame;
		
		for(var r=0;r<this.row;r++){		
		  for(var c=0;c<this.col;c++){
		  
		    if(this.cell[r][c] != undefined && this.cell[r][c].frame == frame && this.cell[r][c] != undefined && this.iceLayer[r][c] == false && this.cell[r][c].frame != 15){		    
		      this.takeCell([r,c]);
		    }
		  }		
		}
	      		
	      }
	    
	    },
	    changeCells:function(cell1,cell2){
	      
	      var tmp = this.cell[cell1[0]][cell1[1]].frame;
	      this.cell[cell1[0]][cell1[1]].frame = this.cell[cell2[0]][cell2[1]].frame;
	      this.cell[cell2[0]][cell2[1]].frame = tmp;
	      
	      this.cell[cell1[0]][cell1[1]].visible = false;
	      this.cell[cell2[0]][cell2[1]].visible = false;
	      
	      var obj1 = this.cell[cell1[0]][cell1[1]];
	      var obj2 = this.cell[cell2[0]][cell2[1]];
	      
	      var clone;
	      
	      clone = new Sprite(this.cell[cell1[0]][cell1[1]].width,this.cell[cell1[0]][cell1[1]].height);
	      clone.x = this.x+this.cell[cell1[0]][cell1[1]].x;
	      clone.y = this.y+this.cell[cell1[0]][cell1[1]].y;
	      clone.image = this.cell[cell1[0]][cell1[1]].image;
	      clone.frame = this.cell[cell1[0]][cell1[1]].frame;
	      
	      game.rootScene.addChild(clone);
	      
	      clone.tl.delay(1+Math.floor(Math.random()*3)).moveTo(this.x+this.cell[cell2[0]][cell2[1]].x,this.y+this.cell[cell2[0]][cell2[1]].y,3).then(function(){
		obj2.visible = true;
		game.rootScene.removeChild(this);
	      });
	      
	      clone = new Sprite(this.cell[cell2[0]][cell2[1]].width,this.cell[cell2[0]][cell2[1]].height);
	      clone.x = this.x+this.cell[cell2[0]][cell2[1]].x;
	      clone.y = this.y+this.cell[cell2[0]][cell2[1]].y;
	      clone.image = this.cell[cell2[0]][cell2[1]].image;
	      clone.frame = this.cell[cell2[0]][cell2[1]].frame;
	      
	      game.rootScene.addChild(clone);
	      
	      clone.tl.delay(1+Math.floor(Math.random()*3)).moveTo(this.x+this.cell[cell1[0]][cell1[1]].x,this.y+this.cell[cell1[0]][cell1[1]].y,3).then(function(){
		obj1.visible = true;
		game.rootScene.removeChild(this);
	      });
	    
	    },
	    randomCells:function(){
	    
	      if ((confirm("Deseja embaralhar o tabuleiro? \n Custo: "+__COST_RANDOM__+" scores. \n Seu score: "+score)) && score >= __COST_RANDOM__) {
		score -= __COST_RANDOM__;
	      }else{
		return;
	      }
	      
	      var possibles = [];
	      
	      for(var r=0;r<this.row;r++){
		for(var c=0;c<this.col;c++){
		
		  var shot = false;
		  for(var s=0;s<this.cannon.length;s++){
		    if(!shot && c == this.cannon[s][1] && r + 1 == this.cannon[s][0]){
		      shot = true;
		      break;
		    }
		  }
		
		  //if(this.cell[r][c] != undefined){
		  //if(this.cell[r][c] != undefined && this.cell[r][c].frame != 15 && this.iceLayer[r][c] == false){
		  if(this.cell[r][c] != undefined && this.cell[r][c].frame != 15 && this.iceLayer[r][c] == false && !shot){
		    possibles.push([r,c]);
		  }
		}
	      }
	      
	      
	      //idea: take an element which have 3 or more.
	      //put their in 0,1,2 positions possibles
	      //never will to stay out moves!!
	      
// 	      var possiblePath = [
// 		[['r','c'],['r','c+1'],['r','c+2']],
// 		[['r','c'],['r+1','c'],['r+2','c']],
// 		[['r','c'],['r+1','c'],['r+1','c+1']],
// 		[['r','c'],['r+1','c+1'],['r+2','c+2']],
// 		[['r','c'],['r-1','c+1'],['r-1','c+2']]
// 	      ];
	      
// 	      for(var i in possibles){
// 		var r = possibles[i][0];
// 		var c = possibles[i][1];
// 		
// 	      }
	      
	      var frameElements = possibles.map(function(p){return plain.cell[p[0]][p[1]].frame;});
	      var frameElementsSort = (frameElements.map(function(k){return k;})).sort();
	      var frameElementsCount = frameElementsSort.map(function(p){return [p,count(frameElementsSort,p)]});
	      
	      for(var i in frameElementsCount){
		if(frameElementsCount[i][1] >= 3){
		  
		  var pos,r1,r2;
		  var dpos = 0;
		  //--1
		  
		  pos = frameElements.indexOf(frameElementsCount[i][0],dpos);
		  dpos = pos+1;		  
		  r1 = possibles[pos];
		  r2 = possibles[0];
		  this.changeCells(r1,r2);
		  
		  //--2
		  
		  pos = frameElements.indexOf(frameElementsCount[i][0],dpos);
		  dpos = pos+1;		  
		  r1 = possibles[pos];
		  r2 = possibles[1];
		  this.changeCells(r1,r2);
		  
		  //--3
		  
		  pos = frameElements.indexOf(frameElementsCount[i][0],dpos);
		  dpos = pos+1;		  
		  r1 = possibles[pos];
		  r2 = possibles[2];
		  this.changeCells(r1,r2);
		  
		  //--
		  possibles.splice(0,1);
		  possibles.splice(0,1);
 		  possibles.splice(0,1);
		  
		  break;
		}
	      }
	      
	      var limit = 50000;
	      
	      while((limit-- >= 0) && possibles.length > 1){
	      
		var r1 = possibles[Math.floor(Math.random()*possibles.length)];
		var r2 = possibles[Math.floor(Math.random()*possibles.length)];
		
		if(r1 != r2){
		
		  this.changeCells(r1,r2);
		  //console.log("change = ",r1," com ",r2);
		  possibles.splice(possibles.indexOf(r1),1);
		  possibles.splice(possibles.indexOf(r2),1);
		
		}
		
	      
	      }
		
	      
	    
	    },
	    buttons:function(){
	      
	      back({x:10,y:game.height-10-80,scale:0.8});
	      restart({x:90,y:game.height-10-80,scale:0.8});
	      music({x:12,y:game.height-10-80-70,scale:0.7});
	      if(this.iceLayerCounter > 0){
		noIce({x:230,y:game.height-10-80,scale:0.7});
	      }
	      if(levelActual > 50){
		removeOne({x:310,y:game.height-10-80,scale:0.7});
	      }
	      if(levelActual > 75){
		collectSame({x:395,y:game.height-10-80,scale:0.8});
	      }
	      
	    },
	    absorb:function(arr){
	      
	      var k = 0;
	      for(var i in arr){
	      
		if(this.cell[arr[i][0]][arr[i][1]] != undefined){
		
		    var clone = new Sprite(80,80);
		    clone.x = plain.x+this.cell[arr[i][0]][arr[i][1]].x;
		    clone.y = plain.y+this.cell[arr[i][0]][arr[i][1]].y;
		    clone.image = this.cell[arr[i][0]][arr[i][1]].image;
		    clone.frame = this.cell[arr[i][0]][arr[i][1]].frame;
		    game.rootScene.addChild(clone);

		    plain.cell[arr[i][0]][arr[i][1]]._visible = false;
		    
		    clone.tl.
		    scaleTo(1.0,1.0,1).rotateBy(45,2,undefined).
		    scaleTo(0.9,0.9,1).rotateBy(45,2,undefined).
		    scaleTo(0.8,0.8,1).rotateBy(45,1,undefined).
		    scaleTo(0.7,0.7,1).rotateBy(45,1,undefined).
		    scaleTo(0.6,0.6,1).rotateBy(45,1,undefined).
		    scaleTo(0.5,0.5,1).rotateBy(45,1,undefined).
		    scaleTo(0.4,0.4,1).rotateBy(45,1,undefined).
		    scaleTo(0.3,0.3,1).rotateBy(45,1,undefined).
		    then(function(){
		      plain.removeChild(plain.cell[arr[k][0]][arr[k][1]]);
		      plain.cell[arr[k][0]][arr[k][1]] = undefined;
		      game.rootScene.removeChild(this);
		      k++;
		    });
		}
	      
	      }
	      
	      plain.inkCells([]);
	      
	    
	    },		      
	    specialTile:function(p){
	    
	      var s = new Sprite(80,80);
	      s.image = game.assets["specialTile.png"];
	      //s.frame = [0,0,0,0,1,1,1,1,2,2,2,2];
	      s.frame = 0;
	      s.x = p[1]*80;
	      s.y = p[0]*80;
	      this.addChild(s);
	      s.tl.fadeOut(15).then(function(){
		plain.removeChild(this);
	      });
	    
	    },
	    watermelon:function(p){
	    
	      var r = p[0];
	      var c = p[1];
		      
	      var spr = new Sprite(107,80);
	      spr.image = game.assets["WatermelonSpecial107x80.png"];
	      spr.frame = [0,0,1,1,2,2,3,3,4,4];
	      spr.x = plain.x+c*80-(107-80)/2;
	      spr.y = plain.y+r*80;
	      game.rootScene.addChild(spr);
	      
	      spr.tl.scaleTo(1.5,1.5,5).scaleTo(1.2,1.2,5).then(function(){
		game.rootScene.removeChild(this);	    
	      });
	      
	      var lbl = new Sprite(200,23);
	      lbl.image = game.assets["MessageBombWatermelon200x23.png"];
	      lbl.frame = 0;
	      lbl.x = (game.width-200)/2;
	      lbl.y = (game.height-23)/2;
	      lbl.scaleX = 2;
	      lbl.scaleY = 2;
	      game.rootScene.addChild(lbl);
	      
	      lbl.tl.scaleTo(2.5,3.8,12).moveBy(0,12,10).scaleTo(2,2,5).moveTo(lbl.x,0,5).then(function(){
		game.rootScene.removeChild(this);	    
	      });
	      
	      this.tl.delay(10).then(function(){
		var arr = [
		  [r-1,c-1],[r-1,c],[r-1,c+1],
		  [r,c-1],[r,c],[r,c+1],
		  [r+1,c-1],[r+1,c],[r+1,c+1]
		];
		
		for(var i in arr){
		
		  var shot = false;
		  for(var s=0;s<this.cannon.length;s++){
		    if(!shot && arr[i][1] == this.cannon[s][1] && arr[i][0] == this.cannon[s][0]){
		      shot = true;
		      break;
		    }
		  }
		
		  //if(arr[i][0] > -1 && arr[i][0] < this.row && arr[i][1] > -1 && arr[i][1] < this.col && this.cell[arr[i][0]][arr[i][1]] != undefined){
		  if(arr[i][0] > -1 && arr[i][0] < this.row && arr[i][1] > -1 && arr[i][1] < this.col && this.cell[arr[i][0]][arr[i][1]] != undefined && !shot){
		    if(this.iceLayer[arr[i][0]][arr[i][1]] == false){//dont take the ice cells!
		      this.specialTile(arr[i]);
		      this.takeCell(arr[i]);
		    }
		  }
		}
		
				
	      });
	      	      
	      __score__ += 5;
	      
	    },
	    pumpking:function(p){
	    
	      var r = p[0];
	      var c = p[1];
	      
	      var spr = new Sprite(26,26);
	      spr.image = game.assets["PumpkinSpecial26x26.png"];
	      spr.frame = [0,1,2,3,4,5,6,7,8,9,10,11];
	      spr.x = plain.x+c*80-(26-80)/2;
	      spr.y = plain.y+r*80;
	      spr.scaleX = 2;
	      spr.scaleY = 2;
	      game.rootScene.addChild(spr);
	      
	      spr.tl.scaleTo(2.5,2.5,6).scaleTo(2,2,6).then(function(){
		game.rootScene.removeChild(this);	    
	      });
	      
	      var lbl = new Sprite(200,26);
	      lbl.image = game.assets["MessageFlashPumpkin200x26.png"];
	      lbl.frame = 0;
	      lbl.x = (game.width-200)/2;
	      lbl.y = (game.height-26)/2;
	      lbl.scaleX = 2;
	      lbl.scaleY = 2;
	      game.rootScene.addChild(lbl);
	      
	      lbl.tl.scaleTo(2.5,3.8,12).moveBy(0,12,10).scaleTo(2,2,5).moveTo(lbl.x,0,5).then(function(){
		game.rootScene.removeChild(this);	    
	      });
	      
	      this.tl.delay(12).then(function(){
		var arr = [
		  [r,c-4],[r,c-3],[r,c-2],[r,c-1],[r,c],[r,c+1],[r,c+2],[r,c+3],[r,c+4],
		  [r-4,c],[r-3,c],[r-2,c],[r-1,c],[r+1,c],[r+2,c],[r+3,c],[r+4,c]
		];
		
		for(var i in arr){
		  
		  var shot = false;
		  for(var s=0;s<this.cannon.length;s++){
		    if(!shot && arr[i][1] == this.cannon[s][1] && arr[i][0] == this.cannon[s][0]){
		      shot = true;
		      break;
		    }
		  }
		  
		  //if(arr[i][0] > -1 && arr[i][0] < this.row && arr[i][1] > -1 && arr[i][1] < this.col && this.cell[arr[i][0]][arr[i][1]] != undefined){
		  if(arr[i][0] > -1 && arr[i][0] < this.row && arr[i][1] > -1 && arr[i][1] < this.col && this.cell[arr[i][0]][arr[i][1]] != undefined && !shot){
		    if(this.iceLayer[arr[i][0]][arr[i][1]] == false){//dont take the ice cells!
		      this.specialTile(arr[i]);
		      this.takeCell(arr[i]);
		    }
		  }
		}
	      });
		
	      __score__ += 10;
	    
	    },
	    check:function(){
	    
	      var nGoals = 0;
	      for(var i in this.blockGoals){
		nGoals += this.blockGoals[i];
	      }	    
	    
	      var on = 0;
	    	    
	      if(this.moves >= 0 && nGoals == 0){
	      
		on = 1;
		
		//console.log("win");
		if(levelMaxUnlocked == levelActual && levelMaxUnlocked < __monsterLevel__[__monsterLevel__.length-1][1]){
		  levelMaxUnlocked++;
		}
		levelActual = levelMaxUnlocked;
		__score__ += parseInt((this.moves*20));
		score -= (-__score__);
			
		check_wait = false;
		
		winner();		
		
		var kxx = setInterval(function(){
		  
		  if(check_wait){
		    main();
		    clearInterval(kxx);
		  }
		  
		},100);
		
// 		main();
// 		return;
	      }
	    
	      if( on != 1 && this.moves <= 0){
		//console.log("lose");
		check_wait = false;
		
		loser();		
		
		var kxx = setInterval(function(){
		  
		  if(check_wait){
		    main();
		    clearInterval(kxx);
		  }
		  
		},100);
		
		return;
	      }
	      
	      //console.log("playing");	    
	    
	    },
	    refreshIceLayer:function(){
		  
	      var len = 0;
	      
	      len = this.iceLayerBefore.childNodes.length;
	      for(var i=0;i<len;i++){
		this.iceLayerBefore.removeChild(this.iceLayerBefore.childNodes[0]);
	      }
	      
	      len = this.iceLayerAfter.childNodes.length;
	      for(var i=0;i<len;i++){
		this.iceLayerAfter.removeChild(this.iceLayerAfter.childNodes[0]);
	      }
	      
	      for(var r=0;r<this.row;r++){
		for(var c=0;c<this.col;c++){
		  var spr;
		  if(this.iceLayer[r][c] == true){
		    
		    spr = new Sprite(80,80);
		    spr.x = c*80;
		    spr.y = r*80;
		    spr.image = game.assets["ice1.3.png"];
		    spr.frame = 0;
		    this.iceLayerBefore.addChild(spr);
		    
		    spr = new Sprite(80,80);
		    spr.x = c*80;
		    spr.y = r*80;
		    spr.image = game.assets["ice1.4.png"];
		    spr.frame = 0;
		    this.iceLayerAfter.addChild(spr);
		    
		  }
		}
	      }
	    },
	    takeCell:function(b){
	      /*
		If case b appoint to ice cell, just remove this ice, otherwise remove the cell, check goals...
	      */
	      
	      for(var s=0;s<this.cannon.length;s++){
		if(b[0][1] == this.cannon[s][1] && b[0][0] == this.cannon[s][0]){
		  return false;
		}
	      }
		  
	      if(this.iceLayer[b[0]][b[1]] == true){
	      
		this.iceLayer[b[0]][b[1]] = false;
		this.refreshIceLayer();
		game.assets["ice.wav"].play();
		
	      }else{
			
		var i = -1;
		if(this.blockTypes.indexOf(12) >= 0){
		  i = 0;
		}else{
		  for(var v in this.validTypeGoals){
		    if(this.validTypeGoals[v][0] == this.cell[b[0]][b[1]].frame){
		      i = this.validTypeGoals[v][1];
		      break;
		    }
		  }
		}
		
		if(i > -1){
			
		  var nBlock = -1;
		  if((k=this.blockTypes.indexOf(12)) >= 0){
		    nBlock = k;
		  }else{
		    for(var v in this.blockTypes){
		      //if(this.blockTypes[v] == this.cell[b[0]][b[1]].frame){
		      if(this.blockTypes[v] == this.cell[b[0]][b[1]].frame){
			nBlock = v;
			break;
		      }
		    }
		  }
		
		  var clone = new Sprite(80,80);
		  clone.x = plain.x+this.cell[b[0]][b[1]].x;
		  clone.y = plain.y+this.cell[b[0]][b[1]].y;
		  clone.image = this.cell[b[0]][b[1]].image;
		  clone.frame = this.cell[b[0]][b[1]].frame;
		  game.rootScene.addChild(clone);
		  
		  //clone.tl.moveTo(plain.blockGoalsPosY+plain.blockGoalsPosX[i],plain.blockGoalsPosY,4).scaleTo(1.2,1.2,3).scaleTo(1,1,3).then(function(){
		  clone.tl.scaleTo(1.1,1.1,4).moveTo(plain.blockGoalsPosY+plain.blockGoalsPosX[i],plain.blockGoalsPosY,4).scaleTo(1.2,1.2,3).scaleTo(1,1,3).then(function(){
		    if(plain.blockGoals[nBlock] > 0){
		      plain.blockGoals[nBlock] -= 1;
		    }
		    if(game.assets["upMonster.ogg"]._state == 0){game.assets["upMonster.ogg"].play();}
		    game.rootScene.removeChild(this);
		  });
		}
	      
		this.removeChild(this.cell[b[0]][b[1]]);
		this.cell[b[0]][b[1]] = undefined;
	      }
	      
	    },
	    pathLengthLabel:function(){
	      var bg = new Label("0");
	      bg.backgroundColor = "rgba(0,0,0,0.7)";
	      bg.width = 40;
	      bg.height = 40;
	      bg.color = "white";
	      bg.font = "35px sans-serif";
	      bg.textAlign = "center";
	      bg._visible = false;
	      game.rootScene.addChild(bg);
	      this.pathLabel = bg;
	      
	    },
	    refreshPathLengthLabel:function(){
	      var tr = this.path[this.path.length-1][0];
	      var tc = this.path[this.path.length-1][1];
	      
	      if(tc == this.cell[0].length-1 && this.cell[0].length == 6){
		this.pathLabel.x = this.x+80*(tc)-20;
	      }else{
		this.pathLabel.x = this.x+80*(1+tc)-20;
	      }
	      this.pathLabel.y = this.y+80*(1+tr)-20;
	      this.pathLabel.text = this.path.length;
	      if(this.path.length > 14){
		this.pathLabel.color = "red";		
	      }else if(this.path.length > 6){
		this.pathLabel.color = "orange";
	      }else{
		this.pathLabel.color = "white";
		
	      }
	      this.pathLabel._visible = true;
	    },
	    movesLabel:function(){
	      var bg = new Label();
	      bg.backgroundColor = "rgba(0,0,0,0.7)";
	      bg.width = 90;
	      bg.height = 50;
	      bg.x = 370;
	      bg.y = 20;
	      bg.color = "white";
	      bg.font = "44px sans-serif";
	      bg.textAlign = "center";
	      bg.on("enterframe",function(){
		if(plain.moves >= 0){
		  this.text = plain.moves;
		}
	      });
	      game.rootScene.addChild(bg);	  
	    },
	    goals:function(){
	      
	      var n = 0;
	      for(var i in this.blockGoals){
		if(this.blockGoals[i] > 0){
		  this.validTypeGoals.push([this.blockTypes[i],n]);
		  n++;
		}
	      }
	      
	      //console.log(this.validTypeGoals);
	      this.blockGoalsPosX = goalsPosX[n-1];
	      
	      var g = new Group();
	      g.x = this.blockGoalsPosY;
	      g.y = this.blockGoalsPosY;
	      g.width = 330;
	      g.height = 80;
	      
	      var bg = new Label();
	      bg.backgroundColor = "rgba(0,0,0,0.7)";
	      bg.width = g.width;
	      bg.height = g.height;
	      g.addChild(bg);
	    
	      var j = 0;
	      for(var i in this.blockGoals){
		if(this.blockGoals[i] > 0){		
		  var spr = new Sprite(80,80);
		  spr.x = this.blockGoalsPosX[j];		
		  spr.y = 0;
		  spr.image = game.assets["semgrade80x80.png"];
		  spr.frame = this.blockTypes[i];
		  spr.scale(0.8,0.8);
		  
		  g.addChild(spr);
		  
		  var num = new Label("");
		  num.x = this.blockGoalsPosX[j]+70;
		  num.y = 30;
		  num.width = 46;
		  num.height = 30;
		  num.color = "white";
		  num.textAlign = "center";
		  num.text = this.blockGoals[i];
		  num.font = "26px sans-serif";
		  num.i = i;
		  
		  num.on("enterframe",function(){
		    if(plain.blockGoals[this.i] > 0){
		      this.text = plain.blockGoals[this.i];
		    }else{
		      this.text = "ok";
		    }
		  });

		  g.addChild(num);
		  
		  j++;
		}
	      }
	      
	      game.rootScene.addChild(g);
	    
	    },
	    hasEmptyCells:function(){
	      
	      for(var c=0;c<this.col;c++){
		if(this.cell[0][c] == undefined){
		  return true;
		}
	      }
	      
	      for(var r=0;r<this.row-1;r++){
		for(var c=0;c<this.col;c++){
		
		  var shot = false;
		  for(var s=0;s<this.cannon.length;s++){
		    if(!shot && c == this.cannon[s][1] && r + 1 == this.cannon[s][0]){
		      shot = true;
		      break;
		    }
		  }
		
		  //if(this.cell[r+1][c] == undefined && this.iceLayer[r][c] == false){
		  //if(this.cell[r+1][c] == undefined && this.iceLayer[r][c] == false && this.cell[r][c] != undefined){
		  if(this.cell[r+1][c] == undefined && this.iceLayer[r][c] == false && this.cell[r][c] != undefined && !shot){
		    return true;
		  }
		}
	      }	    
	      return false;
	      
	    },
	    hasDownCells:function(){
	      
	      for(var r=0;r<this.row-1;r++){
		for(var c=0;c<this.col;c++){
		
		  var shot = false;
		  for(var s=0;s<this.cannon.length;s++){
		    if(!shot && c == this.cannon[s][1] && r + 1 == this.cannon[s][0]){
		      shot = true;
		      break;
		    }
		  }
		
		  //if(this.cell[r+1][c] == undefined && this.iceLayer[r][c] == false && this.cell[r][c] != undefined){
		  if(this.cell[r+1][c] == undefined && this.iceLayer[r][c] == false && this.cell[r][c] != undefined && !shot){
		    return true;
		  }
		}
	      }	    
	      return false;
	      
	    },
	    inkCells:function(arr){
	    
	      for(var r=0;r<this.row;r++){
		for(var c=0;c<this.col;c++){
		  if(this.cell[r][c] != undefined){
		    this.cell[r][c].backgroundColor = "rgba(0,0,0,0)";
		  }
		}
	      }	    
	    
	      for(var i in arr){
		if(this.cell[arr[i][0]][arr[i][1]] != undefined){
		  this.cell[arr[i][0]][arr[i][1]].backgroundColor = "rgba(140,20,20,0.7)";
		}
	      }
	      
	    },
	    insertBlocksFirstRow:function(){
	      for(var c=0;c<this.col;c++){
	      
		if(this.cell[0][c] == undefined){
		  
		  var spr = new Sprite(80,80);
		  spr.x = c*80;
		  spr.y = 0;
		  spr.image = game.assets["semgrade80x80.png"];
		  if(this.blockTypes.indexOf(12) >= 0){
		    var tmp = this.blockTypes.slice(0,this.blockTypes.indexOf(12));
		    spr.frame = tmp[Math.floor(Math.random()*tmp.length)];
		  }else{
		    spr.frame = this.blockTypes[Math.floor(Math.random()*this.blockTypes.length)];
		  }
		  this.addChild(spr);
		  this.cell[0][c] = spr;
		  //spr.tl.delay(Math.floor(Math.random()*100)+100).scaleTo(1.2,1.2,3).scaleTo(0.9,0.9,3).scaleTo(1,1,2).loop();
		  
		}
	      }	  
	    },
	    downBlocks:function(){
	      
	      for(var r=0;r<this.row-1;r++){
		for(var c=0;c<this.col;c++){
		
		  var shot = false;
		  for(var s=0;s<this.cannon.length;s++){
		    if(!shot && c == this.cannon[s][1] && r + 1 == this.cannon[s][0]){
		      shot = true;
		      break;
		    }
		  }
		
		  //if(this.cell[r][c] != undefined && this.iceLayer[r][c] == false){
		  if(this.cell[r][c] != undefined && this.iceLayer[r][c] == false && !shot){
		  
		    var i = r*this.col + c;//iterador
		    
		    if(this.cell[r+1][c] == undefined){
		      
		      var __cell__ = this.cell[r][c];
		    //-- MODE 1		  
		      this.cell[r][c].tl.moveBy(0,80,3);
		    //-- MODE 2
		      //__cell__.y += 80;
		      this.cell[r+1][c] = __cell__;
		      this.cell[r][c] = undefined;
		      
		    //--
		    }
		    
		  }		
		  
		}
	      }	    	  
	    }
	    
	  });
	  
	  
	  winner = function(){
	  
	    if(themeLevel._state != 0)
	      themeLevel.stop();
	    
	    GAME_STATUS = 2;
	    
	    game.assets['winner.ogg'].play();
	    
	    var mask = new Label();
	    mask.width = game.width;
	    mask.height = game.height;
	    mask.x = 0;
	    mask.y = 0;
	    mask.backgroundColor = 'black';
	    mask.opacity = 0;
	    
	    game.rootScene.addChild(mask);
	    mask.tl.fadeIn(120).delay(40).then(function(){game.rootScene.removeChild(this);});	  
	  
	    var s = new Sprite(350,88);
	    s.x = (game.width-s.width)/2;
	    s.y = (game.height-s.height)/2;
	  
	    s.image = game.assets["MessageWinner350x88.png"];
	    s.frame = 0;
	    
	    var yi = s.y;
	    
	    game.rootScene.addChild(s);
	    s.tl.scaleTo(1.25,1.25,57).scaleTo(1.1,1.1,50).scaleTo(1.2,1.2,25).moveBy(-10,0,8).moveTo(game.width,yi,4).delay(10).then(function(){check_wait=true;game.assets['winner.ogg'].stop();game.rootScene.removeChild(this);});
	    
	  };
	  
	  loser = function(){
	  
	    if(themeLevel._state != 0)
	      themeLevel.stop();
	    
	    GAME_STATUS = 2;
	    
	    game.assets['loser.ogg'].play();
	    
	    var mask = new Label();
	    mask.width = game.width;
	    mask.height = game.height;
	    mask.x = 0;
	    mask.y = 0;
	    mask.backgroundColor = 'black';
	    mask.opacity = 0;
	    
	    game.rootScene.addChild(mask);
	    //mask.tl.fadeIn(80).delay(20).then(function(){game.rootScene.removeChild(this);});
	    mask.tl.fadeIn(85).delay(20).then(function(){game.rootScene.removeChild(this);});	  
	  
	    var s = new Sprite(350,88);
	    s.x = (game.width-s.width)/2;
	    s.y = (game.height-s.height)/2;
	  
	    s.image = game.assets["MessageLoser350x88.png"];
	    s.frame = 0;
	    
	    var yi = s.y;
	    
	    game.rootScene.addChild(s);
	    s.tl.scaleTo(1.25,1.25,30).scaleTo(1.1,1.1,30).scaleTo(1.2,1.2,18).moveBy(-10,0,8).moveTo(game.width,yi,4).delay(10).then(function(){check_wait=true;game.assets['loser.ogg'].stop();game.rootScene.removeChild(this);});
	  };
	  
	  var removeOnePos = {x1:0,y1:0,x2:0,y2:0};
	  removeOne = function(p){
	    
	    var spr = new Sprite(80,80);
	    spr.image = game.assets["target.png"];
	    spr.x = p.x;
	    spr.y = p.y;
	    spr.scale(p.scale,p.scale);
	    game.rootScene.addChild(spr);
	    removeOnePos = {x1:spr.x,y1:spr.y,x2:spr.x+80,y2:spr.y+80};
	    
	  };
	  
	  var collectSamePos = {x1:0,y1:0,x2:0,y2:0};
	  collectSame = function(p){
	    
	    var spr = new Sprite(59,80);
	    spr.image = game.assets["collectall.png"];
	    spr.x = p.x;
	    spr.y = p.y;
	    spr.scale(p.scale,p.scale);
	    game.rootScene.addChild(spr);
	    collectSamePos = {x1:spr.x,y1:spr.y,x2:spr.x+59,y2:spr.y+80};
	    
	  };
	  
	  var noIcePos = {x1:0,y1:0,x2:0,y2:0};
	  noIce = function(p){
	    
	    var spr = new Sprite(80,80);
	    spr.image = game.assets["noice.png"];
	    spr.x = p.x;
	    spr.y = p.y;
	    spr.scale(p.scale,p.scale);
	    game.rootScene.addChild(spr);
	    noIcePos = {x1:spr.x,y1:spr.y,x2:spr.x+80,y2:spr.y+80};
	    
	  };
	  
	  var restartPos = {x1:0,y1:0,x2:0,y2:0};
	  restart = function(p){
	    
	    var spr = new Sprite(80,80);
	    spr.image = game.assets["restart.png"];
	    spr.x = p.x;
	    spr.y = p.y;
	    spr.scale(p.scale,p.scale);
	    spr.tl.scaleTo(1,1,30).scaleTo(0.95,0.95,20).scaleTo(p.scale,p.scale,20).delay(120).loop();
	    game.rootScene.addChild(spr);
	    restartPos = {x1:spr.x,y1:spr.y,x2:spr.x+80,y2:spr.y+80};
	    
	  };
	  
	  var backPos = {x1:0,y1:0,x2:0,y2:0};
	  back = function(p){
	    
	    var spr = new Sprite(80,80);
	    spr.image = game.assets["back.png"];
	    spr.x = p.x;
	    spr.y = p.y;
	    spr.scale(p.scale,p.scale);
	    spr.tl.scaleTo(1,1,30).scaleTo(0.95,0.95,20).scaleTo(p.scale,p.scale,20).delay(180).loop();
	    game.rootScene.addChild(spr);
	    backPos = {x1:spr.x,y1:spr.y,x2:spr.x+80,y2:spr.y+80};
	    
	  };
	  
	  var arrayObject = {left:undefined,right:undefined};
	  
	  var arrayLeftPos = {x1:0,y1:0,x2:0,y2:0};
	  arrayLeft = function(p){
	    
	    var spr = new Sprite(80,44);
	    spr.image = game.assets["arrayLeft.png"];
	    spr.x = p.x;
	    spr.y = p.y;
	    spr.scale(p.scale,p.scale);
	    spr.tl.delay(120).scaleTo(1.1,1.1,4).scaleTo(0.95,0.95,4).scaleTo(p.scale,p.scale,4).loop();
	    game.rootScene.addChild(spr);
	    arrayObject.left = spr;
	    arrayLeftPos = {x1:spr.x,y1:spr.y,x2:spr.x+80,y2:spr.y+44};
	  };
	  
	  var arrayRightPos = {x1:0,y1:0,x2:0,y2:0};
	  arrayRight = function(p){
	    
	    var spr = new Sprite(80,44);
	    spr.image = game.assets["arrayRight.png"];
	    spr.x = p.x;
	    spr.y = p.y;
	    spr.scale(p.scale,p.scale);
	    spr.tl.delay(80).scaleTo(1.1,1.1,4).scaleTo(0.95,0.95,4).scaleTo(p.scale,p.scale,4).loop();
	    game.rootScene.addChild(spr);
	    arrayObject.right = spr;
	    arrayRightPos = {x1:spr.x,y1:spr.y,x2:spr.x+80,y2:spr.y+44};
	    
	  };
	  
	  var themeIntro = game.assets["themeIntro.ogg"];
	  var themeLevelA = game.assets["themeLevel.ogg"];
	  var themeLevelB = game.assets["themeLevel2.ogg"];
	  var themeLevel = themeLevelA;
	  var checkMusicCounter = 0;
	  
	  var musicPos = {x1:0,y1:0,x2:0,y2:0,state:false,obj:undefined};
	  music = function(p){
	    
	    var spr = new Sprite(80,80);
	    spr.image = game.assets["music.png"];
	    spr.x = p.x;
	    spr.y = p.y;
	    spr.scale(p.scale,p.scale);
	    if(musicPos.state){
	      spr.frame = 0;
	    }else{
	      spr.frame = 1;
	    }
	    spr.tl.delay(100).scaleTo(1.1,1.1,4).scaleTo(0.95,0.95,4).scaleTo(p.scale,p.scale,4).loop();
	    game.rootScene.addChild(spr);
	    musicPos = {x1:spr.x,y1:spr.y,x2:spr.x+80,y2:spr.y+80,state:musicPos.state,obj:spr};
	    checkMusic();
	  };
	  
		checkMusic = function(){

			if(musicPos.state == true){

				if(GAME_STATUS == 0){
					if(themeIntro._state == 0 || themeIntro.currentTime == themeIntro.duration){themeIntro.play();}
					if(themeLevel._state != 0){themeLevel.stop();}
				}else if(GAME_STATUS == 1){
					if(themeLevel._state == 0 || themeLevel.currentTime == themeLevel.duration){themeLevel.play();}
					if(themeIntro._state != 0){themeIntro.stop();}
				}
				checkMusicCounter=500;

			}else{

				if(themeIntro._state != 0){themeIntro.stop();}
				if(themeLevel._state != 0){themeLevel.stop();}
				checkMusicCounter=0;

			}

		};
	  
		toggleMusic = function(){

			musicPos.state = !musicPos.state;

			if(musicPos.state == true){
				musicPos.obj.frame = 0;

				if(GAME_STATUS == 0){
					if(themeIntro._state == 0 || themeIntro.currentTime == themeIntro.duration){
						themeIntro.play();
						if(themeLevel._state != 0){themeLevel.stop();}
					}	      
				}else if(GAME_STATUS == 1){
					if(themeLevel._state == 0 || themeLevel.currentTime == themeLevel.duration){
						themeLevel.play();
						if(themeIntro._state != 0){themeIntro.stop();}
					}	      
				}

				checkMusicCounter=500;

			}else{
				musicPos.obj.frame = 1;

				if(GAME_STATUS == 0){
					if(themeIntro._state != 0){themeIntro.stop();}
					if(themeLevel._state != 0){themeLevel.stop();}
				}else if(GAME_STATUS == 1){
					if(themeLevel._state != 0){themeLevel.stop();}
					if(themeIntro._state != 0){themeIntro.stop();}
				}

				checkMusicCounter = 0;

			}

		};
	  
	  reset = function(){
	  
	    var len = game.rootScene.childNodes.length;
	    for(var i=0;i<len;i++){
	      game.rootScene.removeChild(game.rootScene.childNodes[0]);
	    }
	    game.rootScene.childNodes = [];	  
	    
	  };	
	  
	  scoreLabel = function(){
	  
	      var bg = new Label(score.toString());
	      bg.width = 250;
	      bg.height = 50;
	      bg.x = game.width-bg.width-20;
	      bg.y = 20;
	      bg.color = "white";
	      bg.backgroundColor = "rgba(0,0,0,0.7)";
	      bg.font = "45px sans-serif";
	      bg.textAlign = "center";
	      game.rootScene.addChild(bg);
	  
	  };
	  
	  neigh = function(arr,p){
	  
	    for(var i in arr){
	      
	      var ax = arr[i][0];
	      var ay = arr[i][1];
	      
	      var dx = Math.abs(ax - p[0]);
	      var dy = Math.abs(ay - p[1]);
	      
	      if(dx <= 1 && dy <= 1){
		return true;
	      }
	      
	    }
	    
	    return false;
	  
	  };
	  
	  inArray = function(arr,p){
	    for(var i in arr){
	      if(arr[i][0]==p[0]&&arr[i][1]==p[1]){
		return true;
	      }
	    }
	    return false;
	  };
	  
	  indexOf = function(arr,p){
	    for(var i in arr){
	      if(arr[i][0]==p[0]&&arr[i][1]==p[1]){
		return i;
	      }
	    }
	    return -1;
	  };
	  
	  count = function(arr,p){
	    var c=0;
	    for(var i in arr)
	      if(arr[i].toString() == p.toString())
		c++;
	    return c;
	  };
	  
		plotBG = function(src){
			var dimen = game.assets[src];
			var bg = new Sprite(dimen.width,dimen.height);
			bg.image = game.assets[src];
			bg.scaleX = 1 + (game.width / dimen.width);
			bg.scaleY = 1 + (game.height / dimen.height);
			game.rootScene.addChild(bg);
		};
	  
	  level = function(){
	  
	    reset();
	    __score__ = 0;
	    
	    if(levelActual < 51){
	      themeLevel = themeLevelA;
	    }else{
	      themeLevel = themeLevelB;
	    }
	    
	    switch(levelActual){
	    
	      case 1:
		plotBG("bgC.jpg");
		plain = new Plain(4,3,[0,1,2],[10,10,0],[]);
		plain.moves = 7;
	      break;
	      case 2:
		plotBG("bgC.jpg");
		plain = new Plain(4,4,[0,1,2],[10,20,10],[]);
		//plain.moves = 12;
		plain.moves = 8;
	      break;
	      case 3:
		plotBG("bgC.jpg");
		plain = new Plain(4,4,[1,2,3],[0,20,10],[]);
		//plain.moves = 16;
		plain.moves = 7;
	      break;
	      case 4:
		plotBG("bgC.jpg");
		plain = new Plain(5,4,[0,1,2,3],[0,10,10,0],[]);
		//plain.moves = 12;
		plain.moves = 8;
	      break;
	      case 5:
		plotBG("bgC.jpg");
		plain = new Plain(5,4,[0,2,3],[10,30,0],[]);
		//plain.moves = 20;
		plain.moves = 9;
	      break;
	      case 6:
		plotBG("bgC.jpg");
		plain = new Plain(5,3,[0,1,1,2],[10,0,0,20],[]);
		//plain.moves = 18;
		plain.moves = 9;
	      break;
	      case 7:
		plotBG("bgC.jpg");
		plain = new Plain(4,5,[0,1,2,3],[30,30,10,0],[]);
		//plain.moves = 22;
		plain.moves = 17;
	      break;
	      case 8:
		plotBG("bgC.jpg");
		plain = new Plain(5,4,[0,1,2,3],[0,32,32,32],[]);
		//plain.moves = 21;
		plain.moves = 17;
	      break;
	      case 9:
		plotBG("bgC.jpg");
		plain = new Plain(4,4,[0,1,2,3],[28,0,28,0],[]);
		//plain.moves = 17;
		plain.moves = 18;
	      break;
	      case 10:
		plotBG("bgC.jpg");
		plain = new Plain(5,4,[0,1,2,3,12],[0,0,0,0,100],[]);
		//plain.moves = 23;
		plain.moves = 13;
	      break;
	      case 11:
		plotBG("bgC.jpg");
		plain = new Plain(5,5,[0,2,3,4],[0,30,0,30],[]);
		//plain.moves = 21;
		plain.moves = 15;
	      break;
	      case 12:
		plotBG("bgC.jpg");
		plain = new Plain(3,5,[1,3,3,3,4],[0,28,0,0,16],[]);
		//plain.moves = 24;
		plain.moves = 10;
	      break;
	      case 13:
		plotBG("bgC.jpg");
		plain = new Plain(5,5,[1,2,3,4],[25,25,0,25],[]);
		//plain.moves = 23;
		plain.moves = 12;
	      break;
	      case 14:
		plotBG("bgC.jpg");
		plain = new Plain(6,4,[0,1,3,4],[20,30,30,0],[]);
		//plain.moves = 25;
		plain.moves = 15;
	      break;
	      case 15:
		plotBG("bgB.jpg");
		plain = new Plain(5,4,[0,1,2,4],[20,20,20,0],[]);
		//plain.moves = 19;
		plain.moves = 14;
	      break;
	      case 16:
		plotBG("bgB.jpg");
		plain = new Plain(4,6,[0,2,3,3],[30,0,0,0],[]);
		//plain.moves = 24;
		plain.moves = 12;
	      break;
	      case 17:
		plotBG("bgB.jpg");
		plain = new Plain(5,5,[1,2,3,5],[24,20,20,0],[]);
		//plain.moves = 25;
		plain.moves = 12;
	      break;
	      case 18:
		plotBG("bgB.jpg");
		plain = new Plain(6,4,[0,2,4,5],[0,0,25,20],[]);
		//plain.moves = 21;
		plain.moves = 14;
	      break;
	      case 19:
		plotBG("bgB.jpg");
		plain = new Plain(6,5,[2,3,4,5,5,5],[21,0,10,0,0,0],[]);
		//plain.moves = 24;
		plain.moves = 12;
	      break;
	      case 20:
		plotBG("bgB.jpg");
		plain = new Plain(5,5,[0,1,4,5,12],[0,0,0,0,150],[]);
		//plain.moves = 26;
		plain.moves = 16;
	      break;
	      case 21:
		plotBG("bgB.jpg");
		plain = new Plain(5,4,[0,2,4,6],[0,24,24,0],[]);
		//plain.moves = 21;
		plain.moves = 13;
	      break;
	      case 22:
		plotBG("bgB.jpg");
		plain = new Plain(4,5,[1,3,5,6],[25,0,25,27],[]);
		//plain.moves = 24;
		plain.moves = 13;
	      break;
	      case 23:
		plotBG("bgB.jpg");
		plain = new Plain(5,5,[0,3,4,6],[26,0,26,0],[]);
		//plain.moves = 23;
		plain.moves = 14;
	      break;
	      case 24:
		plotBG("bgB.jpg");
		plain = new Plain(4,4,[1,4,4,6],[18,0,0,18],[]);
		//plain.moves = 11;
		plain.moves = 11;
	      break;
	      case 25:
		plotBG("bgB.jpg");
		plain = new Plain(4,6,[1,2,3,5],[0,0,32,35],[]);
		//plain.moves = 26;
		plain.moves = 19;
	      break;
	      case 26:
		plotBG("bgB.jpg");
		plain = new Plain(4,4,[0,2,4,6],[20,20,0,0],[[2,1],[2,2],[3,1],[3,2]]);
		//plain.moves = 21;
		plain.moves = 19;
	      break;
	      case 27:
		plotBG("bgB.jpg");
		plain = new Plain(5,4,[1,3,5,7],[25,0,25,35],[[1,1],[1,2],[3,1],[3,2]]);
		//plain.moves = 27;
		plain.moves = 18;
	      break;
	      case 28:
		plotBG("bgB.jpg");
		plain = new Plain(6,3,[3,4,6,7],[0,0,33,0],[[1,1],[2,1],[3,1],[4,1]]);
		//plain.moves = 24;
		plain.moves = 23;
	      break;
	      case 29:
		plotBG("bgB.jpg");
		plain = new Plain(6,3,[0,2,5,7],[20,0,0,20],[[5,0],[5,2],[4,1],[4,0],[4,2]]);
		//plain.moves = 22;
		plain.moves = 22;
	      break;
	      case 30:
		plotBG("bgB.jpg");
		plain = new Plain(5,5,[1,2,4,6,12],[0,0,0,0,175],[[1,1],[1,2],[1,3],[2,1],[2,3],[3,2]]);
		//plain.moves = 23;
		plain.moves = 21;
	      break;
	      case 31:
		plotBG("bgD.jpg");
		plain = new Plain(3,6,[0,3,3,5,7],[18,0,0,18,14],[[1,0],[1,2],[1,3],[1,5],[0,0],[0,5]]);
		//plain.moves = 21;
		plain.moves = 18;
	      break;
	      case 32:
		plotBG("bgD.jpg");
		plain = new Plain(5,6,[2,4,5,7],[19,19,0,0],[[1,0],[2,0],[3,0],[4,0],[1,2],[2,2],[3,2],[4,2],[1,4],[2,4],[3,4],[4,4]]);
		//plain.moves = 16;
		plain.moves = 16;
	      break;
	      case 33:
		plotBG("bgD.jpg");
		plain = new Plain(5,4,[0,3,6,7],[21,0,25,21],[[1,0],[2,1],[2,2],[1,3],[3,0],[4,1],[4,2],[3,3]]);
		//plain.moves = 19;
		plain.moves = 18;
	      break;
	      case 34:
		plotBG("bgD.jpg");
		plain = new Plain(5,5,[0,2,5,6],[0,30,28,0],[[0,0],[1,1],[2,2],[1,3],[0,4]]);
		//plain.moves = 21;
		plain.moves = 19;
	      break;
	      case 35:
		plotBG("bgD.jpg");
		plain = new Plain(4,5,[3,4,6,7],[30,0,21,21],[[0,0],[1,0],[2,0],[3,0],[3,1],[3,2],[3,3],[3,4],[2,4],[1,4],[0,4]]);
		//plain.moves = 24;
		plain.moves = 19;
	      break;
	      case 36:
		plotBG("bgD.jpg");
		plain = new RestrictivePlain(4,4,[1,2,3,5],[0,0,7,0],[[2,0],[2,3]]);
		//plain.moves = 18;
		plain.moves = 12;
	      break;
	      case 37:
		plotBG("bgD.jpg");
		plain = new RestrictivePlain(5,4,[2,4,6,7],[0,0,0,8],[[3,1],[3,2],[3,3]]);
		//plain.moves = 19;
		plain.moves = 8;
	      break;
	      case 38:
		plotBG("bgD.jpg");
		plain = new RestrictivePlain(5,5,[0,2,4,6],[7,7,0,0],[[2,2],[2,1],[2,3],[1,2],[3,2]]);
		//plain.moves = 17;
		plain.moves = 14;
	      break;
	      case 39:
		plotBG("bgD.jpg");
		plain = new RestrictivePlain(6,3,[1,3,5,7],[0,10,0,10],[[3,0],[4,2],[5,0],[2,2]]);
		//plain.moves = 19;
		plain.moves = 21;
	      break;
	      case 40:
		plotBG("bgD.jpg");
		plain = new Plain(6,4,[0,5,6,7,12],[0,0,0,0,200],[[1,1],[2,1],[2,2],[3,1],[3,2],[4,2]]);
		//plain.moves = 24;
		plain.moves = 23;
	      break;
	      case 41:
		plotBG("bgD.jpg");
		plain = new Plain(4,6,[2,3,5,7],[32,0,32,32],[[0,1],[1,1],[2,1],[1,3],[2,3],[3,3],[0,5],[1,5],[2,5]]);
		//plain.moves = 25;
		plain.moves = 21;
	      break;
	      case 42:
		plotBG("bgD.jpg");
		plain = new Plain(4,4,[3,3,4,5],[0,0,42,0],[[0,0],[1,1],[2,2],[3,3],[0,3],[3,0]]);
		//plain.moves = 24;
		plain.moves = 19;
	      break;
	      case 43:
		plotBG("bgD.jpg");
		plain = new Plain(5,3,[2,6,7,8],[21,0,21,21],[[2,0],[2,2],[3,1],[4,0],[4,1],[4,2]]);
		//plain.moves = 24;
		plain.moves = 22;
	      break;
	      case 44:
		plotBG("bgD.jpg");
		plain = new RestrictivePlain(4,5,[2,4,6,8],[0,9,9,7],[[2,0],[3,1],[3,2],[3,3],[2,4]]);
		//plain.moves = 21;
		plain.moves = 15;
	      break;
	      case 45:
		plotBG("bgD.jpg");
		plain = new RestrictivePlain(5,5,[1,3,5,7],[10,12,0,0],[[2,0],[1,1],[3,1],[2,2],[1,3],[3,3],[2,4]]);
		//plain.moves = 23;
		plain.moves = 18;
	      break;
	      case 46:
		plotBG("bgE.jpg");
		plain = new Plain(5,4,[4,6,7,8],[20,0,28,28],[[0,3],[1,2],[2,0],[3,1],[4,2]]);
		//plain.moves = 27;
		plain.moves = 18;
	      break;
	      case 47:
		plotBG("bgE.jpg");
		//plain = new RestrictivePlain(5,5,[1,3,5,8],[0,0,7,15],[[0,1],[0,2],[0,3],[1,0],[2,0],[3,0],[4,1],[4,2],[4,3],[1,4],[2,4],[3,4],[2,2]]);
		plain = new RestrictivePlain(5,5,[1,3,5,8],[0,0,7,15],[[1,0],[2,0],[3,0],[4,1],[4,2],[4,3],[1,4],[2,4],[3,4],[2,2]]);
		//plain.moves = 21;
		plain.moves = 22;
	      break;
	      case 48:
		plotBG("bgE.jpg");
		plain = new Plain(4,4,[2,5,6,8],[26,26,24,0],[[2,0],[2,1],[2,2],[2,3],[3,0],[3,1],[3,2],[3,3]]);
		//plain.moves = 24;
		plain.moves = 25;
	      break;
	      case 49:
		plotBG("bgE.jpg");
		//plain = new RestrictivePlain(5,6,[0,2,3,5,7],[13,0,0,0,0],[[2,0],[2,1],[2,2],[2,3],[2,4],[2,5],[3,0],[3,1],[3,2],[3,3],[3,4],[4,0],[4,1],[4,2],[4,3],[4,4],[1,2],[1,3]]);
		plain = new RestrictivePlain(5,6,[0,2,3,5,7],[13,0,0,0,0],[[2,0],[2,1],[2,2],[2,3],[2,4],[3,0],[3,1],[3,2],[3,3],[3,4],[4,0],[4,1],[4,2],[4,3],[4,4]]);
		//plain.moves = 22;
		plain.moves = 20;
	      break;
	      case 50:
		plotBG("bgE.jpg");
		plain = new Plain(6,4,[1,3,4,5,8],[0,32,0,32,0],[[3,0],[4,0],[5,0],[3,1],[4,1],[5,1],[3,2],[4,2],[5,2],[5,3]]);
		//plain.moves = 30;
		plain.moves = 30;
	      break;
	      case 51:
		plotBG("bgE.jpg");		
		plain = new Plain(5,5,[0,2,4,5,7],[28,0,28,0,28],[[2,1],[2,2],[2,3],[1,1],[1,3],[3,2]]);
		plain.witch = new Witch(2);
		plain.moves = 26;
	      break;
	      case 52:
		plotBG("bgE.jpg");
		plain = new Plain(4,5,[1,3,4,6,8],[0,0,21,0,21],[[3,0],[3,1],[3,2],[3,3],[3,4],[2,0],[2,1],[2,2],[2,3],[2,4],[1,0],[1,1],[1,3],[1,4]]);
		plain.witch = new Witch(2);
		plain.moves = 23;
	      break;
	      case 53:
		plotBG("bgE.jpg");
		plain = new Plain(5,5,[0,2,4,6,8],[0,32,0,0,0],[[3,0],[3,1],[3,2],[3,3],[2,0],[2,3]]);
		plain.witch = new Witch(2);
		plain.moves = 23;
	      break;
	      case 54:
		plotBG("bgE.jpg");
		plain = new Plain(5,5,[0,1,2,3,4],[0,42,0,0,0],[[3,0],[3,1],[3,2],[3,3],[2,0],[2,1],[2,2],[2,3],[1,0],[1,3]]);
		plain.witch = new Witch(2);
		plain.moves = 26;
	      break;
	      case 55:
		plotBG("bgE.jpg");
		plain = new RestrictivePlain(5,4,[1,3,5,6,7],[9,0,0,9,0],[[2,1],[2,2],[3,1],[3,2],[4,1],[4,2],[4,0],[4,3]]);
		plain.moves = 28;
	      break;
	      case 56:
		plotBG("bgE.jpg");
		plain = new Plain(5,6,[0,2,4,6,8,12],[0,0,0,0,0,250],[[4,0],[4,1],[4,2],[4,3],[4,4],[4,5],[3,1],[3,2],[3,3],[3,4]]);
		plain.witch = new Witch(3);
		plain.moves = 30;
	      break;
	      case 57:
		plotBG("bgE.jpg");
		plain = new Plain(4,4,[1,3,4,5,7],[0,16,16,0,0],[[3,0],[3,1],[3,2],[3,3],[2,0],[2,1],[2,2],[2,3]]);
		plain.witch = new Witch(4);
		plain.moves = 20;
	      break;
	      case 58:
		plotBG("bgE.jpg");
		plain = new Plain(6,5,[0,2,4,6,8],[0,0,0,25,25],[[0,0],[0,1],[1,1],[2,1],[3,0],[3,1],[1,3],[2,3]]);
		plain.witch = new Witch(3);
		plain.moves = 27;
	      break;
	      case 59:
		plotBG("bgE.jpg");
		plain = new RestrictivePlain(5,5,[1,3,5,7,9],[7,7,7,0,0],[[0,0],[0,1],[1,0],[1,1],[2,0],[2,1],[3,0],[3,1],[4,0],[4,1],[4,2],[4,3],[4,4]]);
		//plain.moves = 28;
		plain.moves = 16;
	      break;
	      case 60:
		plotBG("bgE.jpg");
		plain = new Plain(6,3,[0,2,4,8,9],[24,0,0,0,24],[[5,0],[5,1],[5,2],[4,0],[4,1],[4,2],[3,0],[3,2]]);
		plain.witch = new Witch(3);
		plain.moves = 23;
	      break;
	      case 61:
		plotBG("bgF.jpg");
		plain = new Plain(5,4,[3,6,7,8,9],[23,0,0,23,21],[[4,0],[4,2],[3,0],[3,2],[2,0],[2,2]]);
		plain.witch = new Witch(3);
		plain.moves = 26;
	      break;
	      case 62:
		plotBG("bgF.jpg");
		plain = new Plain(5,4,[1,4,5,6,9],[21,0,0,0,25],[[1,0],[1,1],[1,2],[1,3],[2,0],[2,1],[2,2],[2,3],[3,0],[3,3]]);
		plain.witch = new Witch(3);
		plain.moves = 26;
	      break;
	      case 63:
		plotBG("bgF.jpg");
		plain = new Plain(5,4,[0,2,5,7,9],[0,0,28,0,0],[[0,0],[1,0],[2,0],[3,0],[4,0],[0,3],[1,3],[2,3],[3,3],[4,3]]);
		plain.witch = new Witch(3);
		plain.moves = 23;
	      break;
	      case 64:
		plotBG("bgF.jpg");
		plain = new Plain(4,6,[4,6,7,8,9],[0,24,0,0,24],[[0,0],[0,1],[1,0],[1,1],[2,0],[2,1],[3,0],[3,1],[0,5],[1,5],[2,5],[3,5]]);
		plain.witch = new Witch(3);
		plain.moves = 25;
	      break;
	      case 65:
		plotBG("bgF.jpg");
		plain = new Plain(5,4,[3,6,7,8,9],[23,0,0,23,21],[[4,0],[4,2],[3,0],[3,2],[2,0],[2,2]]);
		plain.witch = new Witch(3);
		plain.moves = 26;
	      break;
	      case 66:
		plotBG("bgF.jpg");
		plain = new Plain(5,5,[0,1,2,6,8],[25,0,25,0,25],[[0,0],[1,0],[2,0],[3,0],[4,0],[2,1],[2,2],[2,3],[2,4],[4,1],[4,2],[4,3],[4,4]]);
		plain.witch = new Witch(3);
		plain.moves = 30;
	      break;
	      case 67:
		plotBG("bgF.jpg");
		plain = new RestrictivePlain(5,4,[1,2,4,6,9],[0,9,0,0,12],[[2,0],[2,1],[3,2],[3,3],[1,0],[4,3],[4,0],[0,3]]);
		plain.moves = 25;
	      break;
	      case 68:
		plotBG("bgF.jpg");
		plain = new RestrictivePlain(6,3,[2,4,5,7,9],[0,7,0,7,7],[[3,0],[5,0],[5,1],[5,2],[3,2]]);
		plain.moves = 29;
	      break;
	      case 69:
		plotBG("bgF.jpg");
		plain = new Plain(5,5,[0,3,5,6,9,12],[0,0,0,0,0,280],[[4,1],[4,2],[4,3],[3,1],[3,2],[3,3],[2,1],[2,2],[2,3]]);
		plain.witch = new Witch(5);
		plain.moves = 31;
	      break;
	      case 70:
		plotBG("bgF.jpg");
		plain = new Plain(4,6,[0,1,2,8,9],[0,0,0,0,45],[[2,2],[2,3],[2,4],[3,2],[3,3],[3,4]]);
		plain.witch = new Witch(4);
		plain.moves = 28;
	      break;
	      case 71:
		plotBG("bgF.jpg");
		plain = new RestrictivePlain(5,4,[1,5,7,8,9],[8,0,8,8,0],[[2,0],[4,1],[2,2],[4,3]]);
		plain.moves = 30;
	      break;
	      case 72:
		plotBG("bgG.jpg");
		plain = new FallenPlain(5,5,[0,5,6,8,15],[0,0,0,0,3],[[3,1],[3,2],[3,3],[2,1],[2,2],[2,3],[4,0],[4,2],[4,4]]);
		plain.moves = 21;
	      break;
	      case 73:
		plotBG("bgG.jpg");
		plain = new Plain(4,5,[1,5,6,8,9],[0,24,26,0,24],[[3,0],[2,0],[3,1],[2,1],[3,3],[2,3],[3,4],[2,4]]);
		plain.moves = 25;
	      break;
	      case 74:
		plotBG("bgG.jpg");
		plain = new RestrictivePlain(5,4,[0,2,3,7,9],[0,8,0,11,0],[[4,0],[3,0],[4,3],[3,3]]);
		plain.moves = 23;
	      break;
	      case 75:
		plotBG("bgG.jpg");
		plain = new RestrictivePlain(6,4,[1,4,6,7,8],[0,7,7,0,7],[[1,1],[1,2],[2,1],[2,2]]);
		plain.moves = 25;
	      break;
	      case 76:
		plotBG("bgG.jpg");
		plain = new Plain(6,4,[2,5,6,7,9],[0,28,0,24,0],[[2,1],[3,1],[4,1],[2,2],[3,2],[4,2]]);
		plain.witch = new Witch(5);
		plain.moves = 27;
	      break;
	      case 77:
		plotBG("bgG.jpg");
		plain = new Plain(6,3,[1,3,4,5,9],[26,0,26,0,26],[[5,0],[5,1],[5,2],[4,0],[4,1],[4,2]]);
		plain.witch = new Witch(5);
		plain.moves = 21;
	      break;
	      case 78:
		plotBG("bgG.jpg");
		plain = new FallenPlain(4,5,[1,3,4,8,15],[0,0,0,21,3],[[3,0],[3,1],[2,1],[2,2],[2,3],[3,3],[3,4]]);
		plain.moves = 25;
	      break;
	      case 79:
		plotBG("bgG.jpg");
		plain = new FallenPlain(5,5,[0,2,4,9,15],[18,0,0,18,3],[[4,0],[4,2],[4,4],[3,1],[3,3]]);
		//plain.moves = 27;
		plain.moves = 13;
	      break;
	      case 80:
		plotBG("bgG.jpg");
		plain = new FallenPlain(5,6,[1,5,7,8,15],[16,0,0,16,3],[[4,0],[4,2],[4,4],[3,1],[3,3],[3,5]]);
		//plain.moves = 29;
		plain.moves = 18;
	      break;
	      case 81:
		plotBG("bgG.jpg");
		plain = new FallenPlain(5,5,[0,1,2,3,15],[0,0,0,0,5],[[4,0],[4,2],[4,4],[3,1],[3,3],[2,0],[2,2],[2,4]]);
		//plain.moves = 28;
		plain.moves = 15;
	      break;
	      case 82:
		plotBG("bgG.jpg");
		plain = new Plain(5,5,[3,4,6,9,12],[0,0,0,0,310],[[2,0],[2,1],[2,3],[2,4],[3,0],[3,1],[3,3],[3,4],[4,0],[4,1],[4,3],[4,4]]);
		plain.witch = new Witch(4);
		plain.moves = 32;
	      break;
	      case 83:
		plotBG("bgG.jpg");
		plain = new Plain(6,4,[0,3,6,8,9],[0,35,0,0,32],[[5,0],[4,0],[5,1],[4,1],[2,2],[2,3],[3,2],[3,3]]);
		plain.witch = new Witch(5);
		plain.moves = 30;
	      break;
	      case 84:
		plotBG("bgG.jpg");
		plain = new Plain(5,4,[2,7,8,10],[0,0,0,54],[[3,0],[3,1],[3,2],[3,3],[4,0],[4,3]]);		
		plain.moves = 36;
	      break;
	      case 85:
		plotBG("bgG.jpg");
		plain = new Plain(5,5,[0,4,6,9,10],[21,0,21,0,21],[[4,0],[3,0],[2,0],[2,1],[2,2],[2,3],[2,4],[3,2],[4,2],[3,4],[4,4]]);
		plain.witch = new Witch(4);
		plain.moves = 24;
	      break;
	      case 86:
		plotBG("bgG.jpg");
		plain = new Plain(6,5,[1,5,8,9,10],[0,0,0,23,23],[[5,0],[4,0],[3,0],[3,1],[3,3],[3,4],[4,4],[5,4],[5,1],[5,3]]);
		plain.witch = new Witch(4);
		plain.moves = 24;
	      break;
	      case 87:
		plotBG("bgH.jpg");
		plain = new Plain(5,5,[2,4,6,8,10],[25,0,0,25,0],[[4,0],[4,1],[4,2],[4,3],[4,4],[2,0],[2,1],[2,2],[2,3],[2,4],[3,0],[3,2],[3,4]]);
		plain.witch = new Witch(5);
		plain.moves = 28;
	      break;
	      case 88:
		plotBG("bgH.jpg");
		plain = new Plain(5,5,[1,3,5,7,9],[16,0,16,0,16],[[4,0],[4,1],[4,2],[4,3],[4,4],[3,0],[2,0],[3,2],[2,2]]);
		plain.witch = new Witch(4);
		plain.moves = 23;
	      break;
	      case 89:
		plotBG("bgH.jpg");
		plain = new RestrictivePlain(5,5,[0,1,2,3,10],[0,0,7,0,7],[[1,0],[1,1],[1,3],[1,4],[2,2],[3,2],[4,2]]);
		plain.moves = 22;
	      break;
	      case 90:
		plotBG("bgH.jpg");
		plain = new RestrictivePlain(5,6,[4,5,7,9],[0,7,0,16],[[2,0],[2,1],[2,2],[2,3],[2,4],[2,5],[3,0],[3,1],[3,4],[3,5]]);
		plain.moves = 25;
	      break;
	      case 91:
		plotBG("bgH.jpg");
		plain = new FallenPlain(5,5,[0,5,7,10,15],[0,0,0,21,5],[[2,0],[3,0],[3,1],[3,3],[3,4],[4,4]]);
		plain.moves = 27;
	      break;
	      case 92:
		plotBG("bgH.jpg");
		plain = new FallenPlain(5,5,[0,5,6,8,15],[21,0,0,0,4],[[1,1],[2,2],[3,3],[1,3],[3,1]]);
		plain.moves = 23;
	      break;
	      case 93:
		plotBG("bgH.jpg");
		plain = new Plain(4,6,[1,2,7,9,10],[30,30,0,0,30],[[2,0],[2,1],[2,2],[2,3],[2,4],[3,0],[3,1],[3,2],[3,3],[3,4]]);
		plain.witch = new Witch(4);
		plain.moves = 30;
	      break;
	      case 94:
		plotBG("bgH.jpg");
		plain = new RestrictivePlain(4,6,[1,2,6,8,9],[0,0,9,7,7],[[2,0],[2,1],[2,2],[2,3],[2,4],[3,0],[3,1],[3,2],[3,3],[3,4]]);
		plain.moves = 24;
	      break;
	      case 95://MY BIRTHDAY
		plotBG("bgH.jpg");
		plain = new Plain(6,5,[2,4,8,10],[22,0,7,91],[[5,4],[4,3],[5,2],[3,4],[5,0],[4,1],[3,2],[2,3],[1,4]]);
		plain.witch = new Witch(5);
		plain.moves = 34;
	      break;
	      case 96:
		plotBG("bgH.jpg");
		plain = new Plain(5,5,[0,5,7,9,12],[0,0,0,0,350],[[2,0],[2,1],[2,2],[2,3],[2,4],[0,2],[1,2],[3,2],[4,2]]);
		plain.witch = new Witch(3);
		plain.moves = 31;
	      break;
	      case 97:
		plotBG("bgH.jpg");
		plain = new FallenPlain(5,5,[1,3,6,10,15],[28,24,0,0,3],[[2,0],[2,1],[2,2],[2,3],[2,4],[3,2],[4,2]]);
		plain.moves = 32;
	      break;
	      case 98:
		plotBG("bgH.jpg");
		plain = new RestrictivePlain(5,5,[1,4,5,8,10],[0,0,7,7,7],[[4,3],[4,4],[2,3],[2,4],[3,1],[3,2],[3,3],[4,0],[4,1],[2,0],[2,1]]);
		plain.moves = 29;
	      break;
	      case 99:
		plotBG("bgH.jpg");
		plain = new Plain(6,5,[3,6,6,9,9,10,10],[24,0,0,0,0,0,0],[[5,0],[5,2],[5,4],[4,1],[4,2],[4,3],[3,0],[3,2],[3,4]]);
		plain.witch = new Witch(8);
		plain.moves = 18;
	      break;
	      case 100:
		plotBG("bgH.jpg");
		plain = new FallenPlain(6,3,[2,4,8,11,15],[16,0,16,0,9],[[5,0],[5,1],[5,2],[4,0],[4,1],[4,2]]);
		plain.moves = 32;
	      break;
	      case 101:
		plotBG("bgH.jpg");
		plain = new CannonPlain(5,5,[1,3,5,8],[32,50,0,32],[[3,1],[2,2],[3,3]],[[4,2,-1,0]]);
		plain.moves = 24;
	      break;
	      case 102:
		plotBG("bgH.jpg");
		plain = new CannonPlain(5,5,[3,4,6,9],[0,65,65,0],[],[[3,1,0,1]]);
		plain.moves = 26;
	      break;
	      case 103:
		plotBG("bgH.jpg");
		plain = new CannonPlain(5,6,[0,1,3,7],[28,28,0,28],[],[[2,0,0,1],[3,5,0,-1]]);
		plain.moves = 28;
	      break;
	      default:	      
		main();
	      break;
	      
	    }
	  
	  };
	  	  
	  refreshArrayMonsterLevel = function(){
	  
	      if(monsterLevelIndex == 0){
		arrayObject.left.visible = false;
	      }else if(monsterLevelIndex == __monsterLevel__.length-1){
		arrayObject.right.visible = false;
	      }else{
		arrayObject.right.visible = true;
		arrayObject.left.visible = true;
	      }	      	      
	    
	  };
	  	  
	  prevMonsterLevel = function(){
	  
	    
	    if(monsterLevelIndex > 0){
	      monsterLevelIndex -= 1;
	      monsterLevel();
	      refreshArrayMonsterLevel();
	      game.assets["menu.wav"].play();
	    }
	    
	    
	  };
	  
	  nextMonsterLevel = function(){
	  
	  	  
	    if(monsterLevelIndex < __monsterLevel__.length - 1){
	      monsterLevelIndex += 1;
	      monsterLevel();
	      refreshArrayMonsterLevel();
	      game.assets["menu.wav"].play();
	    }	
	    
	  };
	  
	  var __groupMonsterLevel__;
	  monsterLevel = function(){
	  
	    game.rootScene.removeChild(__groupMonsterLevel__);
	    __groupMonsterLevel__ = undefined;
	  
	    var g = new Group();
	    g.width = 80*5;
	    g.height = 80*5;
	    g.x = (game.width-g.width)/2;
	    g.y = (game.height-g.height)/2;
	    
	    var bg = new Label();
	    bg.backgroundColor = "rgba(0,0,0,0.7)";
	    bg.width = g.width;
	    bg.height = g.height;
	    g.addChild(bg);	  
	    
	    //for(var i=p[0];i<p[1];i++){
	    for(var i=__monsterLevel__[monsterLevelIndex][0];i<__monsterLevel__[monsterLevelIndex][1];i++){
	      var btn = new Label("Level "+(i+1));
	      btn.x = ((i%25)%5)*80;
	      btn.y = (parseInt((i%25)/5))*80;
	      btn.width = 80;
	      btn.height = 80;	      
	      //btn.font = "20px sans-serif";
	      if((i+1).toString().length == 2){
		btn.font = "20px sans-serif";
	      }else if((i+1).toString().length == 3){
		btn.font = "18px sans-serif";
	      }
	      btn.textAlign = "center";
	      
	      if(i % 2 == 0){
		btn.backgroundColor = "rgba(0,0,0,0)";
		btn.color = "white";
	      }else{
		btn.backgroundColor = "rgba(255,255,255,0.5)";
		btn.color = "black";
	      }
	      g.addChild(btn);
	      
	      var spr = new Sprite(58,55);
	      spr.image = game.assets["monsterLevels58x55.png"];
	      spr.x = ((i%25)%5)*80 + 11;
	      spr.y = parseInt((i%25)/5)*80 + 25;
	      
	      if(i < levelMaxUnlocked-1){
		spr.frame = 1;
	      }else if(i == levelMaxUnlocked-1){
		spr.frame = 2;
		btn.backgroundColor = "rgba(20,140,20,0.7)";
	      }else{
		spr.frame = 0;
	      }
	      
	      g.addChild(spr);
	      
	    }
	    game.rootScene.addChild(g);
	    __groupMonsterLevel__ = g;
	    
	  };
		  
	  main = function(){
	    
	    GAME_STATUS = 0;
	    reset();
	    plotBG("bgA.jpg");
	    
	    //monsterLevelIndex = parseInt(levelActual/25);
	    //monsterLevelIndex = parseInt((levelActual-1)/25);
	    monsterLevelIndex = parseInt((levelMaxUnlocked-1)/25);
	    
	    monsterLevel();	  
	    scoreLabel();
	    restart({x:20,y:20,scale:0.8});
	    arrayLeft({x:60,y:game.height-140,scale:1});
	    arrayRight({x:160,y:game.height-140,scale:1});
	    
	    music({x:95,y:23,scale:0.8});
	    
	    refreshArrayMonsterLevel();
	    
	    storage.save(levelActual,levelMaxUnlocked,score);
	    
	  };
	  
	  var witchCounter = 0;
	  var victoryCounter = 0;
	  var watermelonCounter = 0;
	  var pumpkingCounter = 0;
	  var shotCannonCounter = 0;
	  var lastPath = [];
	  var touchBusy = false;
	  var Thread = window.setInterval(function(){
	    
	    switch(GAME_STATUS){
	      case 0:
	      
		if(checkMusicCounter > 1){
		  checkMusicCounter--;
		}else if(checkMusicCounter == 1){
		  checkMusicCounter = 0;
		  checkMusic();
		}
		
	      break;
	      case 1:
		if(plain != undefined){

		  if(plain.witch != undefined){
		    if(witchCounter > 1){
		      witchCounter--;
		    }else if(witchCounter == 1){
		      witchCounter = 0;
		      plain.witch.action();
		    }
		  }
		  		  
		  if(waitRemoveOne && plain.path.length == 1 && !touchBusy){
		    plain.removeOne(plain.path[0]);
		    plain.turnOff();
		    waitRemoveOne = false;
		  }else if(waitRemoveOne && plain.path.length == 0 && touchBusy){
		    plain.turnOff();
		    waitRemoveOne = false;
		    score += __COST_REMOVE_ONE__;
		  }else
	      
		  if(waitCollectSame && plain.path.length == 1 && !touchBusy){
		    plain.collectSame(plain.path[0]);
		    plain.turnOff();
		    waitCollectSame = false;
		  }else if(waitCollectSame && plain.path.length == 0 && touchBusy){
		    plain.turnOff();
		    waitCollectSame = false;
		    score += __COST_COLLECT_SAME__;
		  }
		  
		  if(plain.cannon != undefined){		    
		    if(shotCannonCounter > 1){
		      shotCannonCounter--;
		    }else if(shotCannonCounter == 1){		    
		      //console.log("shot!");
		      shotCannonCounter = 0;
		      plain.shotCannon();
		    }
		  }
		  
		  
		  if((lastPath.length > 0) && (watermelonCounter != 0 || pumpkingCounter != 0)){
		  
		    if(watermelonCounter != 0){
		    
		      if(watermelonCounter > 1){
			watermelonCounter--;
		      }else if(watermelonCounter == 1){
			//console.log("watermelon");
			watermelonCounter = 0;
			plain.watermelon(lastPath);
			lastPath = [];
		      }
		      
		    }else{
		    
		      if(pumpkingCounter > 1){
			pumpkingCounter--;
		      }else if(pumpkingCounter == 1){
			//console.log("pumpking");
			pumpkingCounter = 0;
			plain.pumpking(lastPath);
			lastPath = [];
		      }
		      
		    }
		    
		    //lastPath = [];
		    
		  }
		  
		  if(victoryCounter > 1){
		    victoryCounter--;
		  }else if(victoryCounter == 1){
		    //console.log("check");
		    victoryCounter = 0;
		    plain.check();
		  }
	      
		  if(plain.hasEmptyCells()){
		    plain.insertBlocksFirstRow();
		  }
		  
		  if(plain.hasDownCells()){
		    plain.downBlocks();
		  }
		  
		  if(!plain.hasEmptyCells() && !plain.hasDownCells()){		
		    
		    if(plain.frame != -1 && touchBusy == false){

		      if(plain.path.length >= 3){
			for(var i in plain.path){
			  plain.takeCell(plain.path[i]);
			}
			
			if(plain.frame != 15){
			  plain.moves--;
			  __score__ += plain.path.length*2;
			}
			
			if(plain.path.length > 14){
			  //pumpking
			  pumpkingCounter = 7;
			  lastPath = [plain.path[plain.path.length-1][0],plain.path[plain.path.length-1][1]];
			}else if(plain.path.length > 6){
			  //watermelon
			  watermelonCounter = 5;
			  lastPath = [plain.path[plain.path.length-1][0],plain.path[plain.path.length-1][1]];
			}
			
			//if(plain.witch != undefined){witchCounter = 25;}
			if(plain.witch != undefined){
			  witchCounter = 10;
			  if(watermelonCounter != 0 || pumpkingCounter != 0){
			    witchCounter += 15;
			  }
			}
			
			if(plain.frame != 15){
			  if(victoryCounter == 0){
			    shotCannonCounter = 10 + pumpkingCounter + watermelonCounter + witchCounter;
			  }else{
			    shotCannonCounter = 0;
			  }
			}
			
		      }
		      plain.path = [];
		      plain.frame = -1;	    
		      plain.unInk = true;
		      //victoryCounter = 25;
		      victoryCounter = 28;		      
		      //plain.moves--;
		      
		    }else if(plain.unInk == true){
		    
		      plain.inkCells(plain.path);
		      plain.unInk = false;
		    }
		  
		  }
		  
		  if(checkMusicCounter > 1){
		    checkMusicCounter--;
		  }else if(checkMusicCounter == 1){
		    checkMusicCounter = 0;
		    checkMusic();
		  }
		  
		}
	      break;
	    }

	    
	  },50);
	  
	  game.rootScene.on("touchstart",function(event){
	  
	  
	    switch(GAME_STATUS){
	      case 1:
	  
		//if(touchBusy == false && plain.unInk == false){
		if(touchBusy == false && plain.unInk == false && (plain.witch == undefined || (plain.witch != undefined && plain.witch.ready))){
		  
		  var ex = -1;
		  var ey = -1;
		  
		  if(event.localX >= plain.x){
		    ex = parseInt((event.localX-plain.x)/80);
		  }
		
		  if(event.localY >= plain.y){
		    ey = parseInt((event.localY-plain.y)/80);
		  }
		  
		  var shot = false;
		  if(plain.cannon != undefined){
		    for(var s=0;s<plain.cannon.length;s++){
		      if(!shot && plain.cannon[s][0] == ey && plain.cannon[s][1] == ex){
			shot = true;
			break;
		      }
		    }
		  }
		  
		  //console.log(ex,ey);
		  //if(event.localX >= plain.x && event.localX <= plain.x+plain.width && event.localY >= plain.y && event.localY <= plain.y+plain.height){
		  if(event.localX >= plain.x && event.localX <= plain.x+plain.width && event.localY >= plain.y && event.localY <= plain.y+plain.height && !shot){
		    if(plain.cell[ey][ex] != undefined){
		      if(plain.path.length == 0 && inArray(plain.path,[ey,ex]) == false){
			
			plain.frame = plain.cell[ey][ex].frame;
			plain.path.push([ey,ex]);
			plain.inkCells(plain.path);
			plain.refreshPathLengthLabel();
			game.assets["select.wav"].play();
			
		      }
		    }	  
		  }
		  
		  touchBusy = true;
		}
	      break;
	    }
	  
	  });
	  var last = [];
	  game.rootScene.on("touchmove",function(event){
		  
	    switch(GAME_STATUS){
	      case 1:
	      
		//if(touchBusy == true){
		if(!waitCollectSame && !waitRemoveOne && touchBusy == true && (plain.witch == undefined || (plain.witch != undefined && plain.witch.ready))){
	      
		  var ex = -1;
		  var ey = -1;
		  
		  if(event.localX >= plain.x){
		    ex = parseInt((event.localX-plain.x)/80);
		  }
		
		  if(event.localY >= plain.y){
		    ey = parseInt((event.localY-plain.y)/80);
		  }
		  
		  var shot = false;
		  if(plain.cannon != undefined){
		    for(var s=0;s<plain.cannon.length;s++){
		      if(!shot && plain.cannon[s][0] == ey && plain.cannon[s][1] == ex){
			shot = true;
			break;
		      }
		    }	
		  }
		  
		  //if(last[0] != ex || last[1] != ey){
		  if(!shot && (last[0] != ex || last[1] != ey) && plain.path.length > 0){
		    last = [ex,ey];
		    
		    if(event.localX >= plain.x && event.localX <= plain.x+plain.width && event.localY >= plain.y && event.localY <= plain.y+plain.height){
		      if(plain.cell[ey][ex] != undefined){
		      
			if(plain.cell[ey][ex].frame == plain.frame && neigh(plain.path,[ey,ex]) == true){
		      
			  if(inArray(plain.path,[ey,ex]) == false){
			    plain.path.push([ey,ex]);
			    game.assets["select.wav"].play();
			  }else{
			    //jah tem!
			    var i = indexOf(plain.path,[ey,ex]);
			    var len = plain.path.length;
			    var dif = (len - i - 1);
			    if(dif < len){
			      if(dif > 0){
				plain.path.splice(len-dif,len);
				game.assets["selectCancel.wav"].play();
			      }
			    }
			  }
			}
			
			plain.inkCells(plain.path);
			plain.refreshPathLengthLabel();
		      }
		    }
		    
		  }	    
		  
		  
	      
		}
	      break;
	    }
	    
	  });	
	  game.rootScene.on("touchend",function(event){
	  
	    switch(GAME_STATUS){
	      case 0:
	      
		  var ex = -1;
		  var ey = -1;
		  
		  //container infos
		  var container = [(game.width-400)/2,(game.height-400)/2,400,400];
		  
		  if(event.localX >= container[0]){
		    ex = parseInt((event.localX-container[0])/80);
		  }
		
		  if(event.localY >= container[1]){
		    ey = parseInt((event.localY-container[1])/80);
		  }
		  
		  if(event.localX >= container[0] && event.localX <= container[0]+container[2] && event.localY >= container[1] && event.localY <= container[1]+container[3]){
		    
		    var z = (25*monsterLevelIndex)+5*ey+ex+1;
		    
		    if(z <= levelMaxUnlocked){
		      game.assets["menu.wav"].play();
		      levelActual = z;
		      GAME_STATUS = 1;
		      level();
		    }else{
		    	if (z == 125) {		    		
		    		if (debugMasterCounter++ > debugMasterTarget) {
		    			score = parseInt(score) + 9999;
		    			storage.save(levelActual, levelMaxUnlocked, score);
			    		game.assets["upMonster.ogg"].play();
			    		debugMasterCounter = 0;
			    		window.setTimeout(function () {window.location.href="";}, 2000);
		    		} else {
		      			game.assets["lockedLevel.wav"].play();		    		
		    		}
		    	} else {
		      		game.assets["lockedLevel.wav"].play();		    		
		    	}
		    }
		    
		  }else if(event.localX >= restartPos.x1 && event.localX <= restartPos.x2 && event.localY >= restartPos.y1 && event.localY <= restartPos.y2){
		    
		    game.assets["menu.wav"].play();
		    if(confirm("Resetar o jogo:")){
		      //console.log("RESET ALL");
		      storage.clear();
		      levelActual = 1;
		      levelMaxUnlocked = 1;
		      score = score_init;
		      main();
		    } else {
		    	storage.save(levelActual, levelMaxUnlocked, score);
		    }
		    
		  }else if(event.localX >= arrayLeftPos.x1 && event.localX <= arrayLeftPos.x2 && event.localY >= arrayLeftPos.y1 && event.localY <= arrayLeftPos.y2){
		    
		    //game.assets["menu.wav"].play();
		    if(monsterLevelIndex > 0){
		      prevMonsterLevel();
		    }
		
		  }else if(event.localX >= arrayRightPos.x1 && event.localX <= arrayRightPos.x2 && event.localY >= arrayRightPos.y1 && event.localY <= arrayRightPos.y2){
		    
		    //game.assets["menu.wav"].play();
		    if(monsterLevelIndex < __monsterLevel__.length-1){
		      nextMonsterLevel();
		    }
		  
		  }else if(event.localX >= musicPos.x1 && event.localX <= musicPos.x2 && event.localY >= musicPos.y1 && event.localY <= musicPos.y2){
		  
		    toggleMusic();
		  
		  }
		
	      break;
	      case 1:
		touchBusy = false;
		plain.pathLabel._visible = false;
		if(plain.path.length >= 3 && event.localX >= plain.x && event.localX <= plain.x+plain.width && event.localY >= plain.y && event.localY <= plain.y+plain.height){
		  game.assets["selectedRelease.wav"].play();
		}
		
		if(event.localX >= restartPos.x1 && event.localX <= restartPos.x2 && event.localY >= restartPos.y1 && event.localY <= restartPos.y2){		
		  
		  game.assets["menu.wav"].play();
// 		  if(confirm("Reiniciar a fase:")){
// 		    level();
// 		  }
		  plain.randomCells();
		  
		}else if(event.localX >= backPos.x1 && event.localX <= backPos.x2 && event.localY >= backPos.y1 && event.localY <= backPos.y2){
		  
		  game.assets["menu.wav"].play();
		  if(confirm("Inicio do jogo:")){
		    main();
		  }
		  
		}else if(event.localX >= musicPos.x1 && event.localX <= musicPos.x2 && event.localY >= musicPos.y1 && event.localY <= musicPos.y2){		
		    
		    toggleMusic();
		  
		}else if(event.localX >= noIcePos.x1 && event.localX <= noIcePos.x2 && event.localY >= noIcePos.y1 && event.localY <= noIcePos.y2){		
		    
		    plain.noIce();
		  
		}else if(event.localX >= collectSamePos.x1 && event.localX <= collectSamePos.x2 && event.localY >= collectSamePos.y1 && event.localY <= collectSamePos.y2){		
		    
		    if ((confirm("Remover todos os monstros iguais. \n Custo: "+__COST_COLLECT_SAME__+" scores. \n Seu score: "+score)) && score >= __COST_COLLECT_SAME__) {
		      score -= __COST_COLLECT_SAME__;
		      plain.turnOn();
		      waitCollectSame = true;		      
		    }
		  
		}else if(event.localX >= removeOnePos.x1 && event.localX <= removeOnePos.x2 && event.localY >= removeOnePos.y1 && event.localY <= removeOnePos.y2){		
	
		    if ((confirm("Remover um monstro. \n Custo: "+__COST_REMOVE_ONE__+" scores. \n Seu score: "+score)) && score >= __COST_REMOVE_ONE__) {
		      score -= __COST_REMOVE_ONE__;
		      plain.turnOn();
		      waitRemoveOne = true;		      
		    }
		  
		}
		
	      break;
	    }
	    
	  });

	  //========== INTRO ===========
	  main();	
	  
	};
    
	game.start();
	
      };

    </script>
  </body>
</html>